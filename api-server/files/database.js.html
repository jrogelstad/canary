<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>database.js - Featherbone Server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-server.png" title="Featherbone Server"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Connection.html">Connection</a></li>
                                <li><a href="../classes/Database.html">Database</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/Date.html">Date</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/Money.html">Money</a></li>
                                <li><a href="../classes/Number.html">Number</a></li>
                                <li><a href="../classes/Services.API.html">Services.API</a></li>
                                <li><a href="../classes/Services.CRUD.html">Services.CRUD</a></li>
                                <li><a href="../classes/Services.Currency.html">Services.Currency</a></li>
                                <li><a href="../classes/Services.Events.html">Services.Events</a></li>
                                <li><a href="../classes/Services.Exporter.html">Services.Exporter</a></li>
                                <li><a href="../classes/Services.Feathers.html">Services.Feathers</a></li>
                                <li><a href="../classes/Services.Importer.html">Services.Importer</a></li>
                                <li><a href="../classes/Services.Installer.html">Services.Installer</a></li>
                                <li><a href="../classes/Services.Packager.html">Services.Packager</a></li>
                                <li><a href="../classes/Services.Profile.html">Services.Profile</a></li>
                                <li><a href="../classes/Services.Role.html">Services.Role</a></li>
                                <li><a href="../classes/Services.Routes.html">Services.Routes</a></li>
                                <li><a href="../classes/Services.Services.html">Services.Services</a></li>
                                <li><a href="../classes/Services.Settings.html">Services.Settings</a></li>
                                <li><a href="../classes/Services.Tools.html">Services.Tools</a></li>
                                <li><a href="../classes/Services.Workbooks.html">Services.Workbooks</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/API.html">API</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRUD.html">CRUD</a></li>
                                <li><a href="../modules/Currency.html">Currency</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/Date.html">Date</a></li>
                                <li><a href="../modules/Events.html">Events</a></li>
                                <li><a href="../modules/Feathers.html">Feathers</a></li>
                                <li><a href="../modules/Installer.html">Installer</a></li>
                                <li><a href="../modules/IO.html">IO</a></li>
                                <li><a href="../modules/Number.html">Number</a></li>
                                <li><a href="../modules/Packager.html">Packager</a></li>
                                <li><a href="../modules/Profile.html">Profile</a></li>
                                <li><a href="../modules/Role.html">Role</a></li>
                                <li><a href="../modules/Routes.html">Routes</a></li>
                                <li><a href="../modules/Settings.html">Settings</a></li>
                                <li><a href="../modules/String.html">String</a></li>
                                <li><a href="../modules/Tools.html">Tools</a></li>
                                <li><a href="../modules/Workbooks.html">Workbooks</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: database.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint node*/
/**
    PostgreSQL database connection handlers.
    @module Database
*/
(function (exports) {
    &quot;use strict&quot;;

    const {Pool} = require(&quot;pg&quot;);
    const {Config} = require(&quot;./config&quot;);
    const f = require(&quot;../common/core&quot;);

    const config = new Config();
    const clients = {};

    function prop(store) {
        return function (...args) {
            if (args.length) {
                store = args[0];
            }
            return store;
        };
    }

    /**
        Class for managing database connectivity functions.
        @class Database
        @constructor
    */
    exports.Database = function () {
        let cache;
        let pool;
        let that = {};

        // Reslove connection string
        function setConfig(resp) {
            return new Promise(function (resolve) {
                cache = resp;
                resolve(resp);
            });
        }

        function setNodeId(resp) {
            return new Promise(function (resolve) {
                that.nodeId = resp.nodeId.toSnakeCase();
                resolve(resp);
            });
        }

        // ..........................................................
        // PUBLIC
        //
        /**
            Authenticates user against database credentials, and if successful
            resolves to
            {{#crossLink &quot;User&quot;}}{{/crossLink}}.
            Note this function does not create a persistant client connection.
            All actual client connections are handled by the service account.
            @method authenticate
            @param username
            @param password
            @return {Promise}
        */
        that.authenticate = function (username, password) {
            return new Promise(function (resolve, reject) {
                // Do connection
                function doConnect(resp) {
                    return new Promise(function (resolve, reject) {
                        let login;

                        login = new Pool({
                            host: resp.postgres.host,
                            database: resp.postgres.database,
                            user: username,
                            password: password,
                            port: resp.postgres.port
                        });

                        login.connect(function (err, ignore, done) {
                            // handle an error from the connection
                            done();

                            if (err) {
                                reject(err);
                                return;
                            }

                            that.deserializeUser(username).then(
                                resolve
                            ).catch(reject);
                        });
                    });
                }

                // If no connection string, go get it
                Promise.resolve().then(
                    config.read
                ).then(
                    doConnect
                ).then(
                    resolve
                ).catch(
                    reject
                );
            });
        };
        /**
            Database connection object. This object is requested from a
            connection pool and passed forward through all actions of a
            transaction until it is completed. Featherbone automatically
            handles connections and transactions, however it is important to
            know that any service that makes a
            {{#crossLink &quot;Datasource/request:method&quot;}}{{/crossLink}}
            on another service needs to reference the
            {{#crossLink &quot;Client&quot;}}{{/crossLink}} forwarded to it.
            @class Connection
            @static
        */
        /**
            @property client
            @type Client
            @final
        */
        /**
            Called when transaction is completed and returns client to the pool.
            @method done
        */
        /**
            A Featherbone object which references a client connection created
            by the &lt;a href=&#x27;https://node-postgres.com&#x27;&gt;node-postgres&lt;/a&gt; library
            for handling postgres connectivity.
            It also contains several properties for keeping track of
            transaction state and the user account making requests.

            Use {{#crossLink &quot;Database/getClient:method&quot;}}{{/crossLink}} to
            resolve to an actual
            &lt;a href=&#x27;https://node-postgres.com/api/client&#x27;&gt;postgres client&lt;/a&gt;
            and execute SQL.
            @class Client
            @static
        */
        /**
            Unique id to reference which node-postgres client to use in a
            transaction.
            @property clientId
            @type string
            @final
        */
        /**
            Returns the user name of the user who made a request. Necessary for
            Featherbone authorization management.
            @method currentUser
            @return {String}
        */
        /**
            Prevents recursive triggers from committing until all are done.
            @method isTriggering
            @param {Boolean} flag
            @return {Boolean}
        */
        /**
            Indicates whether client is currently wrapped in a transaction.
            @method wrapped
            @param {Boolean} flag
            @return {Boolean}
        */
        /**
            Resolves to a
            {{#crossLink &quot;Connection&quot;}}{{/crossLink}} using
            the configured postgres user account. If &#x60;referenceOnly&#x60;
            is passed as &#x60;true&#x60; then the connection&#x27;s client value is a
            reference {{#crossLink &quot;client&quot;}}{{/crossLink}}, otherwise the
            client is an actual
            &lt;a href=&#x27;https://node-postgres.com/api/client&#x27;&gt;postgres client&lt;/a&gt;
            connection.
            The reference client is necessary to prevent SQL injection
            within a
            {{#crossLink &quot;datasource&quot;}}{{/crossLink}}
            {{#crossLink &quot;datasource/request:method&quot;}}{{/crossLink}} called by
            services written in the web client and stored in the database,
            where otherwise a &quot;real&quot; postgres client is used to execute SQL
            statements for hard coded services such as
            {{#crossLink &quot;Services.CRUD&quot;}}{{/crossLink}},
            {{#crossLink &quot;Services.Events&quot;}}{{/crossLink}} and
            {{#crossLink &quot;Services.Installer&quot;}}{{/crossLink}}.
            @method connect
            @for Database
            @param {Boolean} referenceOnly
            @return {Promise}
        */
        that.connect = function (referenceOnly) {
            return new Promise(function (resolve, reject) {
                let id = f.createId();

                // Do connection
                function doConnect() {
                    return new Promise(function (resolve, reject) {
                        if (!pool) {
                            pool = new Pool(cache.postgres);
                        }

                        pool.connect(function (err, c, d) {
                            // handle an error from the connection
                            if (err) {
                                console.error(
                                    &quot;Could not connect to server&quot;,
                                    err
                                );
                                reject(err);
                                return;
                            }

                            c.clientId = id;
                            c.currentUser = prop();
                            c.isTriggering = prop(false);
                            c.wrapped = prop(false);
                            clients[id] = c;

                            if (referenceOnly) {
                                resolve({
                                    client: Object.freeze({
                                        clientId: c.clientId,
                                        currentUser: c.currentUser,
                                        isTriggering: c.isTriggering,
                                        wrapped: c.wrapped
                                    }),
                                    done: function () {
                                        delete clients[id];
                                        d();
                                    }
                                });
                                return;
                            }

                            resolve({
                                client: c,
                                done: function () {
                                    delete clients[id];
                                    d();
                                }
                            });
                        });
                    });
                }

                if (cache) {
                    doConnect().then(resolve).catch(reject);
                    return;
                }

                // If no config cache, go get it
                Promise.resolve().then(
                    config.read
                ).then(
                    setNodeId
                ).then(
                    setConfig
                ).then(
                    doConnect
                ).then(
                    resolve
                ).catch(
                    reject
                );
            });
        };
        /**
            Object defining a user on the server side for passport management.
            @class User
            @static
        */
        /**
            @property name
            @type String
        */
        /**
            @property isSuper
            @type Boolean
        */
        /**
            @property firstName
            @type String
        */
        /**
            @property lastName
            @type String
        */
        /**
            @property email
            @type String
        */
        /**
            @property phone
            @type String
        */
        /**
            Return user data.
            @method deserializeUser
            @for Database
            @param {String} username User account or role name
            @return {User} User account info
        */
        that.deserializeUser = function (username) {
            return new Promise(function (resolve, reject) {
                const sql = (
                    &quot;SELECT name, is_super, &quot; +
                    &quot;contact.first_name as first_name, &quot; +
                    &quot;contact.last_name as last_name, &quot; +
                    &quot;contact.email AS email, &quot; +
                    &quot;contact.phone AS phone &quot; +
                    &quot;FROM user_account &quot; +
                    &quot;LEFT OUTER JOIN contact ON &quot; +
                    &quot;  (_contact_contact_pk = contact._pk) &quot; +
                    &quot;WHERE name = $1;&quot;
                );

                that.connect().then(function (obj) {
                    obj.client.query(sql, [username]).then(function (resp) {
                        let row;

                        if (!resp.rows.length) {
                            reject(new Error(
                                &quot;User account &quot; + username + &quot; not found.&quot;
                            ));
                        }

                        row = resp.rows[0];
                        row.isSuper = row.is_super;
                        row.firstName = row.first_name || &quot;&quot;;
                        row.lastName = row.last_name || &quot;&quot;;
                        row.email = row.email || &quot;&quot;;
                        row.phone = row.phone || &quot;&quot;;
                        delete row.is_super;
                        delete row.first_name;
                        delete row.last_name;
                        // Send back result
                        resolve(row);
                        obj.done();
                    }).catch(reject);
                });
            });
        };

        /**
            Resolve a reference {{#crossLink &quot;Client&quot;}}{{/crossLink}}
            to an actual
            &lt;a href=&#x27;https://node-postgres.com/api/client&#x27;&gt;postgres client&lt;/a&gt;
            to execute SQL.
            @method getClient
            @param {Client} client
            @return {Object}
        */
        that.getClient = (ref) =&gt; clients[ref.clientId];

        /**
            Resolve to a
            &lt;a href=&#x27;https://node-postgres.com/api/pool&#x27;&gt;connection pool&lt;/a&gt;
            from which to request a connection.
            @method getPool
            @return {Promise}
        */
        that.getPool = function () {
            return new Promise(function (resolve, reject) {
                if (pool) {
                    resolve(pool);
                    return;
                }

                // Create pool
                function doPool() {
                    pool = new Pool(cache.postgres);
                    resolve(pool);
                }

                if (cache) {
                    doPool().then(resolve).catch(reject);
                    return;
                }

                // If no connection string, go get it
                Promise.resolve().then(
                    config.read
                ).then(
                    setNodeId
                ).then(
                    setConfig
                ).then(
                    doPool
                ).catch(
                    reject
                );
            });
        };

        return that;
    };

}(exports));


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
