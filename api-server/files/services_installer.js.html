<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>services\installer.js - Featherbone Server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-server.png" title="Featherbone Server"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Connection.html">Connection</a></li>
                                <li><a href="../classes/Database.html">Database</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/Date.html">Date</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/Money.html">Money</a></li>
                                <li><a href="../classes/Number.html">Number</a></li>
                                <li><a href="../classes/Services.API.html">Services.API</a></li>
                                <li><a href="../classes/Services.CRUD.html">Services.CRUD</a></li>
                                <li><a href="../classes/Services.Currency.html">Services.Currency</a></li>
                                <li><a href="../classes/Services.Events.html">Services.Events</a></li>
                                <li><a href="../classes/Services.Exporter.html">Services.Exporter</a></li>
                                <li><a href="../classes/Services.Feathers.html">Services.Feathers</a></li>
                                <li><a href="../classes/Services.Importer.html">Services.Importer</a></li>
                                <li><a href="../classes/Services.Installer.html">Services.Installer</a></li>
                                <li><a href="../classes/Services.Packager.html">Services.Packager</a></li>
                                <li><a href="../classes/Services.Profile.html">Services.Profile</a></li>
                                <li><a href="../classes/Services.Role.html">Services.Role</a></li>
                                <li><a href="../classes/Services.Routes.html">Services.Routes</a></li>
                                <li><a href="../classes/Services.Services.html">Services.Services</a></li>
                                <li><a href="../classes/Services.Settings.html">Services.Settings</a></li>
                                <li><a href="../classes/Services.Tools.html">Services.Tools</a></li>
                                <li><a href="../classes/Services.Workbooks.html">Services.Workbooks</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/API.html">API</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRUD.html">CRUD</a></li>
                                <li><a href="../modules/Currency.html">Currency</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/Date.html">Date</a></li>
                                <li><a href="../modules/Events.html">Events</a></li>
                                <li><a href="../modules/Feathers.html">Feathers</a></li>
                                <li><a href="../modules/Installer.html">Installer</a></li>
                                <li><a href="../modules/IO.html">IO</a></li>
                                <li><a href="../modules/Number.html">Number</a></li>
                                <li><a href="../modules/Packager.html">Packager</a></li>
                                <li><a href="../modules/Profile.html">Profile</a></li>
                                <li><a href="../modules/Role.html">Role</a></li>
                                <li><a href="../modules/Routes.html">Routes</a></li>
                                <li><a href="../modules/Settings.html">Settings</a></li>
                                <li><a href="../modules/String.html">String</a></li>
                                <li><a href="../modules/Tools.html">Tools</a></li>
                                <li><a href="../modules/Workbooks.html">Workbooks</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: services\installer.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint node eval*/
/**
    @module Installer
*/
(function (exports) {
    &quot;use strict&quot;;

    const MANIFEST = &quot;manifest.json&quot;;

    const {API} = require(&quot;./api&quot;);
    const {Database} = require(&quot;../database&quot;);
    const {Feathers} = require(&quot;./feathers&quot;);
    const fs = require(&quot;fs&quot;);
    const path = require(&quot;path&quot;);
    const f = require(&quot;../../common/core&quot;);

    f.jsonpatch = require(&quot;fast-json-patch&quot;);

    const api = new API();
    const db = new Database();
    const feathers = new Feathers();

    function btoa(str) {
        return Buffer.from(str.toString(), &quot;binary&quot;).toString(&quot;base64&quot;);
    }

    /**
        Install and uninstall packaged modules.
        @class Installer
        @constructor
        @namespace Services
    */
    exports.Installer = function () {
        // ..........................................................
        // PUBLIC
        //

        let that = {};

        /**
            Install a package in a specified directory.

            @method install
            @param {Object} datsource Initialized datasource (catalog loaded)
            @param {Object} client
            @param {String} dir Directory of manifest
            @param {String} user User name
            @param {Boolean} [isSuper] Force as super user
            @return {Promise}
        */
        that.install = function (datasource, client, dir, user, isSuper) {
            return new Promise(function (resolve, reject) {
                let manifest;
                let processFile;
                let i = 0;
                let file;
                let filename = path.format({
                    root: &quot;/&quot;,
                    dir: dir,
                    base: MANIFEST
                });

                f.datasource = datasource;

                function rollback(err) {
                    client.query(&quot;ROLLBACK;&quot;, function () {
                        console.error(err);
                        //console.log(&quot;ROLLBACK&quot;);
                        console.error(&quot;Installation failed.&quot;);
                        resolve();
                    });
                }

                function runBatch(data) {
                    let nextItem;
                    let len = data.length;
                    let b = 0;

                    // Ensure all recentely installed services are now available
                    function getServices() {
                        let payload;
                        let after;

                        after = function (resp) {
                            resp.forEach(function (service) {
                                try {
                                    new Function(
                                        &quot;f&quot;,
                                        &quot;\&quot;use strict\&quot;;&quot; + service.script
                                    )(f);
                                } catch (e) {
                                    reject(e);
                                }
                            });

                            nextItem();
                        };

                        payload = {
                            method: &quot;GET&quot;,
                            name: &quot;getServices&quot;,
                            user: user,
                            client: client
                        };

                        datasource.request(payload, true).then(
                            after
                        ).catch(
                            rollback
                        );
                    }

                    // Iterate recursively
                    nextItem = function () {
                        let payload;

                        if (b &lt; len) {
                            payload = data[b];
                            payload.user = user;
                            payload.client = client;
                            b += 1;
                            datasource.request(payload, true).then(
                                nextItem
                            ).catch(rollback);
                            return;
                        }

                        // We&#x27;re done here
                        processFile();
                    };

                    // Start processing
                    getServices();
                }

                function saveModule(name, script, version, dependencies) {
                    dependencies = dependencies || [];
                    let id = btoa(name);
                    let payload = {
                        method: &quot;POST&quot;,
                        name: &quot;Module&quot;,
                        user: user,
                        client: client,
                        id: id,
                        data: {
                            name: name,
                            version: version,
                            owner: user,
                            script: script,
                            dependencies: dependencies.map(function (dep) {
                                return {
                                    module: {
                                        id: btoa(dep)
                                    }
                                };
                            })
                        }
                    };

                    runBatch([payload]);
                }

                function saveFeathers(feathers, isSystem) {
                    let payload;
                    let data = [];

                    // System feathers don&#x27;t get to be tables
                    if (isSystem) {
                        payload = {
                            method: &quot;PUT&quot;,
                            name: &quot;saveFeather&quot;,
                            user: user,
                            client: client,
                            data: {
                                specs: feathers
                            }
                        };

                        datasource.request(payload, true).then(
                            processFile
                        ).catch(rollback);
                        return;
                    }

                    // Map feather structure to table structure
                    feathers.forEach(function (feather) {
                        let keys = Object.keys(feather.properties || {});
                        let auths = feather.authorizations;
                        let props = feather.properties;
                        let overloads = feather.overloads || {};

                        if (auths) {
                            feather.authorizations = auths.map(function (auth) {
                                return {
                                    role: auth.role,
                                    canCreate: auth.actions.canCreate,
                                    canRead: auth.actions.canRead,
                                    canUpdate: auth.actions.canUpdate,
                                    canDelete: auth.actions.canDelete
                                };
                            });
                        }

                        feather.properties = keys.map(function (key) {
                            let prop = props[key];

                            prop.name = key;

                            return prop;
                        });

                        keys = Object.keys(feather.overloads || {});
                        feather.overloads = keys.map(function (key) {
                            let overload = overloads[key] || {};
                            let row = {};

                            row.name = key;

                            if (overload.description !== undefined) {
                                row.overloadDescription = true;
                                row.description = overload.description;
                            } else {
                                row.overloadDescription = false;
                                row.description = &quot;&quot;;
                            }

                            if (overload.alias !== undefined) {
                                row.overloadAlias = true;
                                row.alias = overload.alias;
                            } else {
                                row.overloadAlias = false;
                                row.alias = &quot;&quot;;
                            }

                            if (overload.type !== undefined) {
                                row.overloadType = true;
                                row.type = overload.type;
                            } else {
                                row.overloadType = false;
                                row.type = null;
                            }

                            if (overload.default !== undefined) {
                                row.overloadDefault = true;
                                row.default = overload.default;
                            } else {
                                row.overloadDefault = false;
                                row.default = null;
                            }

                            if (overload.dataList !== undefined) {
                                row.overloadDataList = true;
                                row.dataList = overload.dataList;
                            } else {
                                row.overloadDataList = false;
                                row.dataList = null;
                            }

                            return row;
                        });

                        data.push({
                            name: &quot;Feather&quot;,
                            method: &quot;POST&quot;,
                            id: feather.name,
                            data: feather
                        });
                    });

                    runBatch(data);
                }

                function saveService(name, module, script) {
                    let id = btoa(&quot;ds&quot; + name);
                    let payload = {
                        method: &quot;POST&quot;,
                        name: &quot;DataService&quot;,
                        user: user,
                        client: client,
                        id: id,
                        data: {
                            name: name,
                            module: module,
                            script: script,
                            owner: user
                        }
                    };

                    runBatch([payload]);
                }

                function saveWorkbooks(workbooks) {
                    let payload = {
                        method: &quot;PUT&quot;,
                        name: &quot;saveWorkbook&quot;,
                        user: user,
                        client: client,
                        data: {
                            specs: workbooks
                        }
                    };

                    datasource.request(payload, true).then(
                        processFile
                    ).catch(rollback);
                }

                function execute(filename) {
                    let dep = path.resolve(filename);
                    let exp = require(dep);

                    exp.execute({
                        user: user,
                        client: client
                    }).then(processFile.bind(client)).catch(rollback);
                }

                function install(filename) {
                    let subman;
                    let subfilepath = path.format({
                        root: &quot;/&quot;,
                        dir: dir,
                        base: filename
                    });
                    let subdir = path.parse(filename).dir;
                    let n = i;

                    fs.readFile(subfilepath, &quot;utf8&quot;, function (err, data) {
                        if (err) {
                            console.error(err);
                            return;
                        }

                        subman = JSON.parse(data);
                        subman.files.forEach(function (file) {
                            file.path = subdir + &quot;/&quot; + file.path;
                            file.module = file.module || subman.module;
                            file.module = file.module || manifest.module;
                            file.version = file.version || subman.version;
                            file.version = file.version || manifest.version;
                            file.dependencies = (
                                file.dependencies || subman.dependencies
                            );
                            file.dependencies = (
                                file.dependencies || manifest.dependencies
                            );
                            manifest.files.splice(n, 0, file);
                            n += 1;
                        });
                        processFile();
                    });
                }

                function defineSettings(settings) {
                    let sql;
                    let params = [settings.name, settings];

                    sql = &quot;SELECT * FROM \&quot;$settings\&quot; WHERE name=&#x27;&quot;;
                    sql += settings.name + &quot;&#x27;;&quot;;

                    client.query(sql, function (err, result) {
                        if (err) {
                            rollback(err);
                            return;
                        }
                        if (result.rows.length) {
                            sql = &quot;UPDATE \&quot;$settings\&quot; SET &quot;;
                            sql += &quot;definition=$2 WHERE name=$1;&quot;;
                        } else {
                            params.push(user);
                            sql = (
                                &quot;INSERT INTO \&quot;$settings\&quot; &quot; +
                                &quot;(name, definition, id, created, &quot; +
                                &quot;created_by, updated, updated_by, &quot; +
                                &quot;is_deleted) &quot; +
                                &quot;VALUES ($1, $2, $1, now(), $3, now(), $3, &quot; +
                                &quot;false);&quot;
                            );
                        }

                        client.query(sql, params, processFile);
                    });
                }

                processFile = function () {
                    let filepath;
                    let module;
                    let version;
                    let dependencies;
                    let content;
                    let name;

                    function complete() {
                        console.log(&quot;Installation completed!&quot;);
                        resolve();
                    }

                    file = manifest.files[i];
                    i += 1;

                    // If we&#x27;ve processed all the files, wrap this up
                    if (!file) {
                        //console.log(&quot;COMMIT&quot;);
                        client.query(&quot;COMMIT;&quot;).then(
                            api.buildClientApi.bind(null, datasource, user)
                        ).then(
                            api.buildRestApi.bind(null, datasource, user)
                        ).then(complete).catch(reject);

                        return;
                    }

                    filename = file.path;
                    name = path.parse(filename).name;
                    filepath = path.format({
                        root: &quot;/&quot;,
                        dir: dir,
                        base: filename
                    });

                    module = file.module || manifest.module;
                    version = file.version || manifest.version;
                    dependencies = file.dependencies || manifest.dependencies;

                    fs.readFile(filepath, &quot;utf8&quot;, function (err, data) {
                        if (err) {
                            console.error(err);
                            return;
                        }

                        content = data;

                        console.log(&quot;Installing &quot; + filename);

                        switch (file.type) {
                        case &quot;install&quot;:
                            install(filename);
                            break;
                        case &quot;execute&quot;:
                            execute(filename);
                            break;
                        case &quot;module&quot;:
                            saveModule(module, content, version, dependencies);
                            break;
                        case &quot;service&quot;:
                            saveService(file.name || name, module, content);
                            break;
                        case &quot;feather&quot;:
                            saveFeathers(JSON.parse(content), file.isSystem);
                            break;
                        case &quot;batch&quot;:
                            runBatch(JSON.parse(content));
                            break;
                        case &quot;workbook&quot;:
                            saveWorkbooks(JSON.parse(content));
                            break;
                        case &quot;settings&quot;:
                            defineSettings(JSON.parse(content));
                            break;
                        default:
                            rollback(&quot;Unknown type.&quot;);
                            return;
                        }
                    });
                };

                function doInstall(resp) {
                    if (!resp) {
                        throw new Error(
                            &quot;You must have superuser priviliges to &quot; +
                            &quot;perform installations.&quot;
                        );
                    }

                    fs.readFile(filename, &quot;utf8&quot;, function (err, data) {
                        if (err) {
                            reject(err);
                        }

                        manifest = JSON.parse(data);
                        client.query(&quot;BEGIN;&quot;).then(processFile);
                    });
                }

                if (isSuper) {
                    doInstall(true);
                    return;
                }

                f.datasource.request({
                    method: &quot;GET&quot;,
                    name: &quot;isSuperUser&quot;,
                    client: client
                }).then(doInstall).catch(reject);
            });
        };

        /**
            Uninstall a module.

            @method deleteModule
            @param {Object} payload
            @param {String | Object} payload.client
            @param {Object} payload.data
            @param {String} payload.data.name Module name
            @return {Promise}
        */
        that.deleteModule = function (obj) {
            return new Promise(function (resolve, reject) {
                let client = db.getClient(obj.client);
                let name = obj.data.name;
                let requests;
                let sql = (
                    &quot;SELECT * FROM module_dependency &quot; +
                    &quot;  JOIN module ON module._pk=_module_script_pk &quot; +
                    &quot;WHERE module.name=$1;&quot;
                );

                function callback(resp) {
                    if (resp.rows.length) {
                        throw new Error(
                            &quot;Can not delete module &quot; + name +
                            &quot; because other modules are dependant on it&quot;
                        );
                    }
                    requests = [
                        client.query(
                            (
                                &quot;DELETE FROM form_attr_column WHERE EXISTS (&quot; +
                                &quot;  SELECT * FROM form_attr, form &quot; +
                                &quot;  WHERE form_attr._pk=_parent_form_attr_pk &quot; +
                                &quot;    AND form._pk=form_attr._parent_form_pk &quot; +
                                &quot;    AND form.module=$1);&quot;
                            ),
                            [name]
                        ),
                        client.query(
                            (
                                &quot;DELETE FROM form_attr WHERE EXISTS (&quot; +
                                &quot;  SELECT * FROM form &quot; +
                                &quot;  WHERE form._pk=form_attr._parent_form_pk &quot; +
                                &quot;    AND form.module=$1);&quot;
                            ),
                            [name]
                        ),
                        client.query(
                            (
                                &quot;DELETE FROM form_tab WHERE EXISTS (&quot; +
                                &quot;  SELECT * FROM form &quot; +
                                &quot;    WHERE form._pk=form_tab._parent_form_pk &quot; +
                                &quot;    AND form.module=$1);&quot;
                            ),
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM form WHERE module=$1&quot;,
                            [name]
                        ),
                        client.query(
                            (
                                &quot;DELETE FROM relation_search_column &quot; +
                                &quot;WHERE EXISTS (&quot; +
                                &quot;  SELECT * FROM relation_widget &quot; +
                                &quot;  WHERE relation_widget._pk=&quot; +
                                &quot;    _parent_relation_widget_pk &quot; +
                                &quot;    AND relation_widget.module=$1);&quot;
                            ),
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM relation_widget WHERE module = $1&quot;,
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM data_service WHERE module=$1&quot;,
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM route WHERE module=$1&quot;,
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM style WHERE module=$1&quot;,
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM \&quot;$workbook\&quot; WHERE module=$1&quot;,
                            [name]
                        ),
                        client.query(
                            (
                                &quot;DELETE FROM module_dependency WHERE EXISTS (&quot; +
                                &quot;  SELECT * FROM module &quot; +
                                &quot;  WHERE _parent_module_pk=module._pk &quot; +
                                &quot;    AND module.name = $1);&quot;
                            ),
                            [name]
                        ),
                        client.query(
                            &quot;DELETE FROM module WHERE name = $1&quot;,
                            [name]
                        )
                    ];

                    Promise.all(requests).then(function () {
                        let found;

                        function deleteFeather(resp) {
                            if (found === undefined) {
                                found = resp.rows;
                            }

                            if (found.length) {
                                feathers.deleteFeather({
                                    client: client,
                                    data: {
                                        name: found.pop().name
                                    }
                                }, true).then(deleteFeather).catch(reject);
                                return;
                            }

                            sql = &quot;DELETE FROM feather WHERE module=$1&quot;;
                            client.query(
                                sql,
                                [name]
                            ).then(resolve).catch(reject);
                        }

                        sql = (
                            &quot;SELECT name FROM feather WHERE module=$1 &quot; +
                            &quot; AND NOT is_deleted &quot; +
                            &quot;ORDER BY _pk;&quot;
                        );
                        client.query(
                            sql,
                            [name]
                        ).then(deleteFeather).catch(reject);
                    }).catch(reject);
                }

                f.datasource.request({
                    method: &quot;GET&quot;,
                    name: &quot;isSuperUser&quot;,
                    client: client
                }).then(function (isSuperUser) {
                    if (!isSuperUser) {
                        throw new Error(
                            &quot;You must have superuser priviliges to &quot; +
                            &quot;uninstall packages.&quot;
                        );
                    }
                    client.query(sql, [name]).then(callback).catch(reject);
                }).catch(reject);
            });
        };

        return that;
    };

}(exports));


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
