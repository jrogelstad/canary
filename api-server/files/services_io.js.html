<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>services\io.js - Featherbone Server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-server.png" title="Featherbone Server"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Connection.html">Connection</a></li>
                                <li><a href="../classes/Database.html">Database</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Money.html">Money</a></li>
                                <li><a href="../classes/Services.API.html">Services.API</a></li>
                                <li><a href="../classes/Services.CRUD.html">Services.CRUD</a></li>
                                <li><a href="../classes/Services.Currency.html">Services.Currency</a></li>
                                <li><a href="../classes/Services.Events.html">Services.Events</a></li>
                                <li><a href="../classes/Services.Exporter.html">Services.Exporter</a></li>
                                <li><a href="../classes/Services.Feathers.html">Services.Feathers</a></li>
                                <li><a href="../classes/Services.Importer.html">Services.Importer</a></li>
                                <li><a href="../classes/Services.Installer.html">Services.Installer</a></li>
                                <li><a href="../classes/Services.Packager.html">Services.Packager</a></li>
                                <li><a href="../classes/Services.Profile.html">Services.Profile</a></li>
                                <li><a href="../classes/Services.Role.html">Services.Role</a></li>
                                <li><a href="../classes/Services.Routes.html">Services.Routes</a></li>
                                <li><a href="../classes/Services.Services.html">Services.Services</a></li>
                                <li><a href="../classes/Services.Settings.html">Services.Settings</a></li>
                                <li><a href="../classes/Services.Tools.html">Services.Tools</a></li>
                                <li><a href="../classes/Services.Workbooks.html">Services.Workbooks</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/API.html">API</a></li>
                                <li><a href="../modules/CRUD.html">CRUD</a></li>
                                <li><a href="../modules/Currency.html">Currency</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/Events.html">Events</a></li>
                                <li><a href="../modules/Feathers.html">Feathers</a></li>
                                <li><a href="../modules/Installer.html">Installer</a></li>
                                <li><a href="../modules/IO.html">IO</a></li>
                                <li><a href="../modules/Packager.html">Packager</a></li>
                                <li><a href="../modules/Profile.html">Profile</a></li>
                                <li><a href="../modules/Role.html">Role</a></li>
                                <li><a href="../modules/Routes.html">Routes</a></li>
                                <li><a href="../modules/Settings.html">Settings</a></li>
                                <li><a href="../modules/Tools.html">Tools</a></li>
                                <li><a href="../modules/Workbooks.html">Workbooks</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: services\io.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint node, this*/
/**
    Import and export
    @module IO
*/
(function (exports) {
    &quot;use strict&quot;;

    const {CRUD} = require(&quot;./crud&quot;);
    const {Feathers} = require(&quot;./feathers&quot;);
    const f = require(&quot;../../common/core&quot;);
    const XLSX = require(&quot;xlsx&quot;);
    const fs = require(&quot;fs&quot;);
    const crud = new CRUD();
    const feathers = new Feathers();

    function getFeather(client, name, localFeathers) {
        return new Promise(function (resolve, reject) {
            function getChildFeathers(resp) {
                let frequests = [];
                let props = resp.properties;

                try {
                    localFeathers[name] = resp;

                    // Recursively get feathers for all children
                    Object.keys(props).forEach(function (key) {
                        let type = props[key].type;

                        if (
                            typeof type === &quot;object&quot; &amp;&amp; (
                                type.parentOf || type.isChild
                            )
                        ) {
                            frequests.push(
                                getFeather(
                                    client,
                                    type.relation,
                                    localFeathers
                                )
                            );
                        }
                    });
                } catch (e) {
                    reject(e);
                    return;
                }

                Promise.all(
                    frequests
                ).then(resolve).catch(reject);
            }

            feathers.getFeather({
                client,
                data: {
                    name: name
                }
            }).then(getChildFeathers).catch(reject);
        });
    }

    /**
        @class Exporter
        @constructor
        @namespace Services
    */
    exports.Exporter = function () {
        // ..........................................................
        // PUBLIC
        //

        let that = {};

        function tidy(obj) {
            delete obj.objectType;
            delete obj.isDeleted;
            delete obj.lock;

            Object.keys(obj).forEach(function (key) {
                if (Array.isArray(obj[key])) {
                    obj[key].forEach(function (row) {
                        delete row.id;
                        tidy(row);
                    });
                }
            });
        }

        function doExport(
            client,
            feather,
            properties,
            filter,
            dir,
            format,
            writeFile
        ) {
            return new Promise(function (resolve, reject) {
                let id = f.createId();
                let filename = dir + id + &quot;.&quot; + format;
                let payload = {
                    client: client,
                    name: feather,
                    filter: filter,
                    properties: properties
                };

                if (properties &amp;&amp; properties.indexOf(&quot;objectType&quot;) === -1) {
                    properties.push(&quot;objectType&quot;);
                }

                function callback(resp) {
                    writeFile(filename, resp, format, client, feather).then(
                        () =&gt; resolve(filename)
                    );
                }

                crud.doSelect(
                    payload,
                    false,
                    true
                ).then(callback).catch(reject);
            });
        }

        function writeWorkbook(filename, data, format, client, feather) {
            return new Promise(function (resolve, reject) {
                let wb = XLSX.utils.book_new();
                let sheets = {};
                let localFeathers = {};
                let keys;
                let key;
                let ws;

                function toSheets(d, rename, feather) {
                    let type;
                    let tmp;
                    let c = 0;

                    function doRename(data, key) {
                        if (
                            key === &quot;objectType&quot; ||
                            key === &quot;isDeleted&quot; ||
                            key === &quot;lock&quot;
                        ) {
                            tmp[key] = data[key];
                        } else {
                            tmp[key.toName()] = data[key];
                        }
                    }

                    if (d.length) {
                        d.forEach(function (row) {
                            let pkey = feather + &quot; Id&quot;;
                            let pval = row.id;
                            let rel;
                            let prop;
                            let cfeather;

                            Object.keys(row).forEach(function (key) {
                                let n;

                                cfeather = localFeathers[feather];
                                prop = cfeather.properties[
                                    key.replace(&quot; &quot;, &quot;&quot;).toCamelCase()
                                ];

                                if (
                                    prop &amp;&amp;
                                    typeof prop.type === &quot;object&quot; &amp;&amp;
                                    prop.type.parentOf
                                ) {
                                    // Add parent key in
                                    rel = prop.type.relation.toCamelCase(true);
                                    n = 0;
                                    row[key] = row[key] || [];
                                    row[key].forEach(function (r) {
                                        tmp = {};
                                        tmp[pkey] = pval;
                                        Object.keys(r).forEach(
                                            doRename.bind(null, r)
                                        );
                                        row[key][n] = tmp;
                                        n += 1;
                                    });
                                    toSheets(row[key], false, rel);
                                    delete row[key];
                                } else if (
                                    prop &amp;&amp; (
                                        typeof prop.type === &quot;object&quot; ||
                                        prop.type === &quot;object&quot;
                                    )
                                ) {
                                    if (prop.type.isChild) {
                                        rel = prop.type.relation.toCamelCase(
                                            true
                                        );

                                        if (
                                            row[key] !== null &amp;&amp;
                                            row[key] !== undefined
                                        ) {
                                            tmp = {};
                                            tmp.objectType = rel;
                                            Object.keys(row[key]).forEach(
                                                doRename.bind(null, row[key])
                                            );
                                            toSheets([tmp], false, rel);
                                            row[key] = row[key].id;
                                        }
                                    } else if (prop.format === &quot;money&quot;) {
                                        if (row[key].effective) {
                                            row[key] = (
                                                row[key].amount + &quot; &quot; +
                                                row[key].currency + &quot; &quot; +
                                                row[key].effective + &quot; &quot; +
                                                row[key].baseAmount
                                            );
                                        } else {
                                            row[key] = (
                                                row[key].amount + &quot; &quot; +
                                                row[key].currency
                                            );
                                        }
                                    } else if (row[key] &amp;&amp; row[key].id) {
                                        row[key] = row[key].id;
                                    }
                                }
                            });

                            if (rename !== false) {
                                tmp = {};
                                Object.keys(row).forEach(
                                    doRename.bind(null, row)
                                );
                                d[c] = tmp;
                                c += 1;
                            }
                        });

                        type = d[0].objectType;
                        if (!sheets[type]) {
                            sheets[type] = d;
                        } else {
                            sheets[type] = sheets[type].concat(d);
                        }
                    }
                }

                function callback() {
                    toSheets(data, true, feather);

                    // Add worksheets in reverse order
                    keys = Object.keys(sheets);
                    while (keys.length) {
                        key = keys.pop();
                        sheets[key].forEach(tidy);
                        ws = XLSX.utils.json_to_sheet(sheets[key]);
                        XLSX.utils.book_append_sheet(wb, ws, key);
                    }

                    XLSX.writeFile(wb, filename, {bookType: format});
                    resolve();
                }

                getFeather(
                    client,
                    feather,
                    localFeathers
                ).then(callback).catch(reject);
            });
        }

        /**
            Export as json.

            @method json
            @param {Object} client Database client
            @param {String} feather Feather name
            @param {Array} properties
            @param {Object} filter
            @param {String} dir Target file directory
            @return {Promise} Resolves filename of exported data
        */
        that.json = function (client, feather, properties, filter, dir) {
            return new Promise(function (resolve, reject) {
                function writeFile(filename, data) {
                    return new Promise(function (resolve) {
                        data.forEach(tidy);

                        fs.appendFile(
                            filename,
                            JSON.stringify(data, null, 4),
                            function (err) {
                                if (err) {
                                    reject(err);
                                    return;
                                }

                                resolve();
                            }
                        );
                    });
                }

                doExport(
                    client,
                    feather,
                    properties,
                    filter,
                    dir,
                    &quot;json&quot;,
                    writeFile
                ).then(resolve).catch(reject);
            });
        };

        /**
            Export as Open Document spreadsheet.

            @method ods
            @param {Object} Database client
            @param {String} Feather name
            @param {Array} Properties
            @param {Object} Filter
            @param {String} Target file directory
            @return {String} Filename
        */
        that.ods = function (client, feather, properties, filter, dir) {
            return new Promise(function (resolve, reject) {
                doExport(
                    client,
                    feather,
                    properties,
                    filter,
                    dir,
                    &quot;ods&quot;,
                    writeWorkbook
                ).then(resolve).catch(reject);
            });
        };

        /**
            Export as Excel spreadsheet.

            @method xlsx
            @param {Object} Database client
            @param {String} Feather name
            @param {Array} Properties
            @param {Object} Filter
            @param {String} Target file directory
            @return {String} Filename
        */
        that.xlsx = function (client, feather, properties, filter, dir) {
            return new Promise(function (resolve, reject) {
                doExport(
                    client,
                    feather,
                    properties,
                    filter,
                    dir,
                    &quot;xlsx&quot;,
                    writeWorkbook
                ).then(resolve).catch(reject);
            });
        };

        return that;
    };

    /**
        @class Importer
        @constructor
        @namespace Services
    */
    exports.Importer = function () {
        // ..........................................................
        // PUBLIC
        //

        let that = {};

        /**
            Import JSON file.

            @method json
            @param {Object} Datasource
            @param {Object} Database client
            @param {String} Feather name
            @param {String} Source file
            @return {Array} Error log
        */
        that.json = function (datasource, client, feather, filename) {
            return new Promise(function (resolve, reject) {
                let requests = [];
                let log = [];

                function error(err) {
                    log.push({
                        feather: this.name,
                        id: this.id,
                        error: err
                    });
                }

                function writeLog() {
                    let logname;

                    if (log.length) {
                        logname = &quot;./files/downloads/&quot; + f.createId() + &quot;.json&quot;;
                        fs.appendFile(
                            logname,
                            JSON.stringify(log, null, 4),
                            function (err) {
                                if (err) {
                                    reject(err);
                                    return;
                                }

                                fs.unlink(filename, function () {
                                    resolve(logname);
                                });
                            }
                        );
                        return;
                    }

                    fs.unlink(filename, resolve);
                }

                function callback(err, data) {
                    if (err) {
                        console.error(err);
                        fs.unlink(filename, reject.bind(null, err));
                        return;
                    }

                    try {
                        data = JSON.parse(data);

                        data.forEach(function (item) {
                            let payload = {
                                method: &quot;POST&quot;,
                                client: client,
                                name: feather,
                                id: item.id,
                                data: item
                            };

                            requests.push(
                                datasource.request(payload).catch(
                                    error.bind(payload)
                                )
                            );
                        });
                    } catch (e) {
                        fs.unlink(filename, reject.bind(null, e));
                        return;
                    }

                    Promise.all(requests).then(writeLog).catch(function (err) {
                        fs.unlink(filename, reject.bind(null, err));
                    });
                }

                fs.readFile(filename, &quot;utf8&quot;, callback);
            });
        };

        /**
            Import Excel file.

            @method xlsx
            @param {Object} Datasource
            @param {Object} Database client
            @param {String} Feather name
            @param {String} Source file
            @return {Array} Error log
        */
        that.xlsx = function (datasource, client, feather, filename) {
            return new Promise(function (resolve, reject) {
                let requests = [];
                let log = [];
                let wb = XLSX.readFile(filename);
                let sheets = {};
                let localFeathers = {};

                wb.SheetNames.forEach(function (name) {
                    sheets[name] = XLSX.utils.sheet_to_json(
                        wb.Sheets[name]
                    );
                });

                function error(err) {
                    log.push({
                        feather: this.name,
                        id: this.id,
                        error: {
                            message: err.message,
                            statusCode: err.statusCode
                        }
                    });
                }

                function buildRow(feather, row) {
                    let ret = {};
                    let props = localFeathers[feather].properties;
                    let ary;
                    let id = row.Id;

                    if (!id) {
                        throw new Error(
                            &quot;Id is required for \&quot;&quot; + feather + &quot;\&quot;&quot;
                        );
                    }

                    try {
                        Object.keys(props).forEach(function (key) {
                            let value = row[key.toName()];
                            let pkey = feather.toName() + &quot; Id&quot;;
                            let rel;
                            let attrs;

                            if (typeof props[key].type === &quot;object&quot;) {
                                // Handle child array
                                if (
                                    props[key].type.parentOf &amp;&amp;
                                    sheets[props[key].type.relation]
                                ) {
                                    rel = props[key].type.relation;
                                    ary = sheets[rel].filter(
                                        (r) =&gt; r[pkey] === id
                                    );
                                    ret[key] = ary.map(
                                        buildRow.bind(null, rel)
                                    );

                                // Handle child object
                                } else if (props[key].type.isChild) {
                                    if (sheets[rel]) {
                                        rel = props[key].type.relation;
                                        ret[key] = sheets[rel].find(
                                            (r) =&gt; r.Id === row[key.toName()]
                                        );
                                        ret[key] = buildRow(rel, ret[key]);
                                    }

                                // Regular relation
                                } else if (value) {
                                    ret[key] = {id: value};
                                }
                            } else if (props[key].format === &quot;money&quot;) {
                                attrs = value.split(&quot; &quot;);
                                ret[key] = {
                                    amount: Number(attrs[0]),
                                    currency: attrs[1],
                                    effective: attrs[2],
                                    baseAmount: Number(attrs[3])
                                };
                            } else if (value !== undefined) {
                                ret[key] = value;
                            }
                        });
                    } catch (e) {
                        reject(e);
                        return;
                    }

                    return ret;
                }

                function doRequest(row) {
                    let payload = {
                        client: client,
                        method: &quot;POST&quot;,
                        name: feather,
                        id: row.Id,
                        data: buildRow(feather, row)
                    };

                    requests.push(
                        datasource.request(payload).catch(
                            error.bind(payload)
                        )
                    );
                }

                function writeLog() {
                    let logname;

                    if (log.length) {
                        logname = &quot;./files/downloads/&quot; + f.createId() + &quot;.json&quot;;
                        fs.appendFile(
                            logname,
                            JSON.stringify(log, null, 4),
                            function (err) {
                                if (err) {
                                    reject(err);
                                    return;
                                }

                                fs.unlink(filename, function () {
                                    resolve(logname);
                                });
                            }
                        );
                        return;
                    }

                    fs.unlink(filename, resolve);
                }

                function callback() {
                    sheets[feather].forEach(doRequest);

                    Promise.all(requests).then(writeLog).catch(reject);
                }

                getFeather(
                    client,
                    feather,
                    localFeathers
                ).then(callback).catch(function (err) {
                    fs.unlink.bind(filename, function () {
                        reject(err);
                    });
                });
            });
        };

        /**
            Import Open Document Spreadsheet file.

            @method ods
            @param {Object} Datasource
            @param {Object} Database client
            @param {String} Feather name
            @param {String} Source file
            @return {Array} Error log
        */
        that.ods = that.xlsx;

        return that;
    };

}(exports));


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
