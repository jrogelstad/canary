<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>services\api.js - Featherbone Server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-server.png" title="Featherbone Server"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Connection.html">Connection</a></li>
                                <li><a href="../classes/Database.html">Database</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/Date.html">Date</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/Money.html">Money</a></li>
                                <li><a href="../classes/Number.html">Number</a></li>
                                <li><a href="../classes/Services.API.html">Services.API</a></li>
                                <li><a href="../classes/Services.CRUD.html">Services.CRUD</a></li>
                                <li><a href="../classes/Services.Currency.html">Services.Currency</a></li>
                                <li><a href="../classes/Services.Events.html">Services.Events</a></li>
                                <li><a href="../classes/Services.Exporter.html">Services.Exporter</a></li>
                                <li><a href="../classes/Services.Feathers.html">Services.Feathers</a></li>
                                <li><a href="../classes/Services.Importer.html">Services.Importer</a></li>
                                <li><a href="../classes/Services.Installer.html">Services.Installer</a></li>
                                <li><a href="../classes/Services.Packager.html">Services.Packager</a></li>
                                <li><a href="../classes/Services.Profile.html">Services.Profile</a></li>
                                <li><a href="../classes/Services.Role.html">Services.Role</a></li>
                                <li><a href="../classes/Services.Routes.html">Services.Routes</a></li>
                                <li><a href="../classes/Services.Services.html">Services.Services</a></li>
                                <li><a href="../classes/Services.Settings.html">Services.Settings</a></li>
                                <li><a href="../classes/Services.Tools.html">Services.Tools</a></li>
                                <li><a href="../classes/Services.Workbooks.html">Services.Workbooks</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/API.html">API</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRUD.html">CRUD</a></li>
                                <li><a href="../modules/Currency.html">Currency</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/Date.html">Date</a></li>
                                <li><a href="../modules/Events.html">Events</a></li>
                                <li><a href="../modules/Feathers.html">Feathers</a></li>
                                <li><a href="../modules/Installer.html">Installer</a></li>
                                <li><a href="../modules/IO.html">IO</a></li>
                                <li><a href="../modules/Number.html">Number</a></li>
                                <li><a href="../modules/Packager.html">Packager</a></li>
                                <li><a href="../modules/Profile.html">Profile</a></li>
                                <li><a href="../modules/Role.html">Role</a></li>
                                <li><a href="../modules/Routes.html">Routes</a></li>
                                <li><a href="../modules/Settings.html">Settings</a></li>
                                <li><a href="../modules/String.html">String</a></li>
                                <li><a href="../modules/Tools.html">Tools</a></li>
                                <li><a href="../modules/Workbooks.html">Workbooks</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: services\api.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint node, devel*/
/**
    API file generator methods called during installation.
    @module API
*/
(function (exports) {
    &quot;use strict&quot;;

    const fs = require(&quot;fs&quot;);
    const f = require(&quot;../../common/core&quot;);

    function processProperties(feather, properties) {
        let keys = Object.keys(feather.properties);

        feather.required = [];

        keys.forEach(function (key) {
            let property = feather.properties[key];
            let newProperty;
            let primitives = Object.keys(f.types);

            function props() {
                let obj = {};

                obj.id = {};
                obj.id.type = &quot;string&quot;;

                property.type.properties.forEach(function (key) {
                    obj[key] = {};
                    // TODO: Figure out what type really is based
                    // on feather
                    obj[key].type = &quot;string&quot;;
                });

                return obj;
            }

            // Bail if child property. Not necessary for api definition
            if (typeof property.type === &quot;object&quot; &amp;&amp; property.type.childOf) {
                return;
            }

            newProperty = {};
            if (property.isRequired === true) {
                feather.required.push(key);
            }

            if (property.description) {
                newProperty.description = property.description;
            }

            if (typeof property.type === &quot;object&quot;) {
                newProperty.type = (
                    property.type.parentOf
                    ? &quot;array&quot;
                    : &quot;object&quot;
                );

                if (newProperty.type === &quot;object&quot;) {
                    newProperty.required = [&quot;id&quot;];
                    newProperty.properties = props();
                } else {
                    newProperty.items = {
                        &quot;$ref&quot;: (
                            &quot;#/components/schemas/&quot; +
                            property.type.relation
                        )
                    };
                }
            } else {
                if (primitives.indexOf(property.type) !== -1) {
                    newProperty.type = property.type;
                } else {
                    throw new Error(
                        &quot;Property type &quot; + property.type +
                        &quot; not supported on &quot; + key + &quot; for feather &quot; +
                        feather.name
                    );
                }
            }

            properties[key] = newProperty;
        });
    }

    /**
        Service for building Open API specification.

        @class API
        @constructor
        @namespace Services
    */
    exports.API = function () {
        // ..........................................................
        // PUBLIC
        //

        let that = {};

        /**
            Build client api specification. Creates api.js in client folder.

            @method buildClientApi
            @param {Object} datasource
            @param {String} username
            @return {Promise}
        */
        that.buildClientApi = function (datasource, username) {
            return new Promise(function (resolve, reject) {
                let content = &quot;&quot;;
                let catalog;
                let payload;
                let keys;

                function callback(resp) {
                    let lastModule = &quot;&quot;;
                    catalog = resp;

                    // Loop through each feather and append to api
                    keys = Object.keys(catalog);
                    keys.sort(function (a, b) {
                        if (catalog[a].module === catalog[b].module) {
                            return (
                                a &lt; b
                                ? -1
                                : 1
                            );
                        }

                        return (
                            catalog[a].module &lt; catalog[b].module
                            ? -1
                            : 1
                        );
                    });

                    keys.forEach(function (key) {
                        let feather = f.copy(catalog[key]);
                        let props = feather.properties || {};

                        if (feather.module !== lastModule) {
                            content += (
                                &quot;/**\n&quot; +
                                &quot;    @module &quot; + feather.module + &quot;\n&quot; +
                                &quot;*/\n&quot;
                            );
                        }

                        content += (
                            &quot;/**\n&quot; +
                            &quot;    @class &quot; + key + &quot;\n&quot; +
                            &quot;    @static\n&quot; +
                            &quot;    @extends Models.&quot; +
                            (feather.inherits || &quot;Object&quot;) + &quot;\n&quot; +
                            &quot;    @namespace Models\n&quot; +
                            &quot;*/\n&quot;
                        );

                        Object.keys(props).forEach(function (p) {
                            let prop = props[p];
                            let readOnly = (
                                prop.isReadOnly
                                ? &quot;    __Read Only__\n\n&quot;
                                : &quot;&quot;
                            );
                            let format = (
                                prop.format
                                ? &quot;    __Format:__ &quot; + prop.format + &quot;\n\n&quot;
                                : &quot;&quot;
                            );
                            let type = (
                                typeof prop.type === &quot;object&quot;
                                ? (
                                    &quot;\n    __Type:__ &quot; +
                                    &quot;{{#crossLink \&quot;&quot; +
                                    prop.type.relation.toCamelCase(true) +
                                    &quot;\&quot;}}{{/crossLink}}&quot; +
                                    &quot;\n\n&quot;
                                )
                                : (
                                    &quot;\n    __Type:__ &#x60;&quot; +
                                    prop.type.toCamelCase(true) + &quot;&#x60;\n\n&quot;
                                )
                            );
                            content += (
                                &quot;/**\n&quot; +
                                &quot;    &quot; + prop.description + &quot;.\n&quot; +
                                type + format + readOnly +
                                &quot;    @property data.&quot; + p + &quot;\n&quot; +
                                &quot;    @type Property&quot; + (
                                    feather.inherits || &quot;Object&quot;
                                ) + &quot;\n&quot; +
                                &quot;    @namespace Models\n&quot; +
                                &quot;*/\n&quot;
                            );
                        });

                        lastModule = catalog[key].module;
                    });

                    // Save api file
                    fs.writeFile(&quot;./client/api.js&quot;, content, function (err) {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        resolve();
                    });
                }

                // Real work starts here
                console.log(&quot;Building Client API specification&quot;);

                // Load the existing feather catalog from postgres
                payload = {
                    method: &quot;GET&quot;,
                    name: &quot;getSettings&quot;,
                    user: username,
                    data: {
                        name: &quot;catalog&quot;
                    }
                };

                datasource.request(payload, true).then(
                    callback
                ).catch(
                    reject
                );
            });
        };

        /**
            Build open api specification. Creates api.json in the root folder.

            @method buildRestApi
            @param {Object} datasource
            @param {String} username
            @return {Promise}
        */
        that.buildRestApi = function (datasource, username) {
            return new Promise(function (resolve, reject) {
                let api;
                let catalog;
                let payload;
                let keys;
                let name;
                let path;
                let tags = [];

                function callback(resp) {
                    let schemas = api.components.schemas;

                    catalog = resp;

                    // Loop through each feather and append to api
                    keys = Object.keys(catalog);
                    keys.sort(function (a, b) {
                        return (
                            a &lt; b
                            ? -1
                            : 1
                        );
                    });

                    keys.forEach(function (key) {
                        name = key.toProperCase();

                        let schema;
                        let feather = catalog[key];
                        let properties = {};
                        let inherits = feather.inherits || &quot;Object&quot;;
                        let tag = key.toSpinalCase();
                        let pathName = &quot;/data/&quot; + tag + &quot;/{id}&quot;;
                        let expResp = {
                            &quot;$ref&quot;: &quot;#/components/schemas/&quot; + key
                        };
                        let errResp = {
                            &quot;$ref&quot;: &quot;#/components/schemas/ErrorResponse&quot;
                        };
                        let patchDef = {
                            tags: [tag],
                            summary: &quot;Update an existing &quot; + name,
                            operationId: &quot;doPatch&quot; + name,
                            parameters: [
                                {
                                    &quot;name&quot;: &quot;id&quot;,
                                    &quot;in&quot;: &quot;path&quot;,
                                    &quot;description&quot;: (
                                        &quot;The id of the &quot; + name +
                                        &quot; to update&quot;
                                    ),
                                    &quot;required&quot;: true,
                                    &quot;schema&quot;: {
                                        &quot;type&quot;: &quot;string&quot;
                                    }
                                }
                            ],
                            requestBody: {
                                $ref: &quot;#/components/requestBodies/JSONPatch&quot;
                            },
                            responses: {
                                &quot;200&quot;: {
                                    &quot;description&quot;: (
                                        &quot;Expected response to a valid request&quot;
                                    ),
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;$ref&quot;: (
                                                    &quot;#/components/&quot; +
                                                    &quot;schemas/JSONPatch&quot;
                                                )
                                            }
                                        }
                                    }
                                },
                                &quot;default&quot;: {
                                    &quot;description&quot;: &quot;Unexpected error&quot;,
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;$ref&quot;: (
                                                    &quot;#/components/&quot; +
                                                    &quot;schemas/ErrorResponse&quot;
                                                )
                                            }
                                        }
                                    }
                                }
                            }
                        };
                        let deleteDef = {
                            tags: [tag],
                            summary: &quot;Delete a &quot; + name,
                            operationId: &quot;doDelete&quot; + name,
                            parameters: [
                                {
                                    &quot;name&quot;: &quot;id&quot;,
                                    &quot;in&quot;: &quot;path&quot;,
                                    &quot;description&quot;: (
                                        &quot;The id of the &quot; + name +
                                        &quot; to delete&quot;
                                    ),
                                    &quot;required&quot;: true,
                                    &quot;schema&quot;: {
                                        &quot;type&quot;: &quot;string&quot;
                                    }
                                }
                            ],
                            responses: {
                                &quot;200&quot;: {
                                    &quot;description&quot;: (
                                        &quot;Boolean indicating succesful deletion&quot;
                                    ),
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;type&quot;: &quot;boolean&quot;
                                            }
                                        }
                                    }
                                },
                                &quot;default&quot;: {
                                    &quot;description&quot;: &quot;Unexpected error&quot;,
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;$ref&quot;: (
                                                    &quot;#/components/&quot; +
                                                    &quot;schemas/ErrorResponse&quot;
                                                )
                                            }
                                        }
                                    }
                                }
                            }
                        };
                        let postDef = {
                            tags: [tag],
                            summary: &quot;Add a new &quot; + name + &quot; to the database&quot;,
                            operationId: &quot;doInsert&quot; + name,
                            requestBody: {
                                &quot;content&quot;: {
                                    &quot;application/json&quot;: {
                                        &quot;schema&quot;: {
                                            &quot;$ref&quot;: (
                                                &quot;#/components/schemas/&quot; + key
                                            )
                                        }
                                    }
                                }
                            },
                            responses: {
                                &quot;200&quot;: {
                                    &quot;description&quot;: (
                                        &quot;Patch list of differences applied&quot; +
                                        &quot;by the server to the request&quot;
                                    ),
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;$ref&quot;: (
                                                    &quot;#/components/&quot; +
                                                    &quot;schemas/JSONPatch&quot;
                                                )
                                            }
                                        }
                                    }
                                },
                                &quot;default&quot;: {
                                    &quot;description&quot;: &quot;Unexpected error&quot;,
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;$ref&quot;: (
                                                    &quot;#/components/&quot; +
                                                    &quot;schemas/ErrorResponse&quot;
                                                )
                                            }
                                        }
                                    }
                                }
                            }
                        };
                        let queryPostDef = {
                            post: {
                                tags: [tag],
                                summary: &quot;Query &quot; + key + &quot; data&quot;,
                                operationId: &quot;doSelect&quot; + name,
                                requestBody: {
                                    $ref: &quot;#/components/requestBodies/Query&quot;
                                },
                                responses: {
                                    &quot;200&quot;: {
                                        &quot;description&quot;: (
                                            feather.plural
                                            ? (
                                                &quot;Array of &quot; +
                                                feather.plural.toProperCase()
                                            )
                                            : &quot;&quot;
                                        ),
                                        &quot;content&quot;: {
                                            &quot;application/json&quot;: {
                                                &quot;schema&quot;: {
                                                    &quot;$ref&quot;: (
                                                        &quot;#/components/&quot; +
                                                        &quot;schemas/&quot; + key
                                                    )
                                                }
                                            }
                                        }
                                    },
                                    &quot;default&quot;: {
                                        &quot;description&quot;: &quot;Unexpected error&quot;,
                                        &quot;content&quot;: {
                                            &quot;application/json&quot;: {
                                                &quot;schema&quot;: {
                                                    &quot;$ref&quot;: (
                                                        &quot;#/components/&quot; +
                                                        &quot;schemas/ErrorResponse&quot;
                                                    )
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        };

                        // Append singluar path
                        if (!feather.isChild) {
                            tags.push({
                                name: tag,
                                description: key + &quot; data&quot;
                            });

                            path = {
                                get: {
                                    tags: [tag],
                                    summary: &quot;Info for a specific &quot; + name,
                                    parameters: [
                                        {
                                            &quot;name&quot;: &quot;id&quot;,
                                            &quot;in&quot;: &quot;path&quot;,
                                            &quot;description&quot;: (
                                                &quot;The id of the &quot; +
                                                name + &quot; to retrieve&quot;
                                            ),
                                            &quot;required&quot;: true,
                                            &quot;schema&quot;: {
                                                &quot;type&quot;: &quot;string&quot;
                                            }
                                        }
                                    ],
                                    responses: {
                                        &quot;200&quot;: {
                                            &quot;description&quot;: (
                                                &quot;Expected response to a &quot; +
                                                &quot;valid request&quot;
                                            ),
                                            &quot;content&quot;: {
                                                &quot;application/json&quot;: {
                                                    &quot;schema&quot;: expResp
                                                }
                                            }
                                        },
                                        &quot;default&quot;: {
                                            &quot;description&quot;: &quot;Unexpected error&quot;,
                                            &quot;content&quot;: {
                                                &quot;application/json&quot;: {
                                                    &quot;schema&quot;: errResp
                                                }
                                            }
                                        }
                                    }
                                }
                            };

                            if (feather.readOnly !== true) {
                                path.patch = patchDef;
                                path.delete = deleteDef;
                            }

                            api.paths[pathName] = path;

                            if (feather.readOnly !== true) {
                                path = {};
                                path.post = postDef;
                                api.components.requestBodies[key] = {
                                    &quot;content&quot;: {
                                        &quot;application/json&quot;: {
                                            &quot;schema&quot;: {
                                                &quot;$ref&quot;: (
                                                    &quot;#/components/schemas/&quot; +
                                                    key
                                                )
                                            }
                                        }
                                    },
                                    &quot;description&quot;: name + &quot; to be added&quot;,
                                    &quot;required&quot;: true
                                };

                                pathName = &quot;/data/&quot; + key.toSpinalCase();
                                api.paths[pathName] = path;
                            }

                            // Append list path
                            if (feather.plural) {
                                path = queryPostDef;

                                pathName = (
                                    &quot;/data/&quot; + feather.plural.toSpinalCase()
                                );
                                api.paths[pathName] = path;
                            }
                        }
                        // Append singular feather definition
                        schema = {};

                        if (feather.description) {
                            schema.description = feather.description;
                        }

                        if (feather.discriminator) {
                            schema.discriminator = feather.discriminator;
                        }

                        processProperties(feather, properties);

                        if (key === &quot;Object&quot;) {
                            delete schema.discriminator;
                            schema.type = &quot;object&quot;;
                            schema.properties = properties;
                        } else {
                            schema.allOf = [{
                                $ref: &quot;#/components/schemas/&quot; + inherits
                            }];

                            if (Object.keys(properties).length) {
                                schema.allOf.push({
                                    properties: properties
                                });
                            }
                        }

                        if (feather.required.length) {
                            schema.required = feather.required;
                        }

                        schemas[key] = schema;
                    });

                    tags.sort(function (a, b) {
                        return (
                            a.name &lt; b.name
                            ? -1
                            : 1
                        );
                    });

                    api.tags = api.tags.concat(tags);

                    api = JSON.stringify(api, null, 4);

                    // Save api file
                    fs.writeFile(
                        &quot;../featherbone-docs/api-rest/api.json&quot;,
                        api,
                        function (err) {
                            if (err) {
                                console.error(
                                    &quot;Cannot write Open API specification as &quot; +
                                    &quot;featherbone-docs repository is not &quot; +
                                    &quot;present.&quot;
                                );
                            }
                            resolve();
                        }
                    );
                }

                // Real work starts here
                console.log(&quot;Building Open API specification&quot;);

                // Load the baseline api file
                fs.readFile(&quot;./server/api-base.json&quot;, &quot;utf8&quot;, function (
                    err,
                    data
                ) {
                    if (err) {
                        console.error(err);
                        return;
                    }

                    api = JSON.parse(data);

                    // Load the existing feather catalog from postgres
                    payload = {
                        method: &quot;GET&quot;,
                        name: &quot;getSettings&quot;,
                        user: username,
                        data: {
                            name: &quot;catalog&quot;
                        }
                    };

                    datasource.request(payload, true).then(
                        callback
                    ).catch(
                        reject
                    );
                });
            });
        };

        return that;
    };

}(exports));
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
