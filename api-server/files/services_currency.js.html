<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>services\currency.js - Featherbone Server</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-server.png" title="Featherbone Server"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Connection.html">Connection</a></li>
                                <li><a href="../classes/Database.html">Database</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/Date.html">Date</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/Money.html">Money</a></li>
                                <li><a href="../classes/Number.html">Number</a></li>
                                <li><a href="../classes/Services.API.html">Services.API</a></li>
                                <li><a href="../classes/Services.CRUD.html">Services.CRUD</a></li>
                                <li><a href="../classes/Services.Currency.html">Services.Currency</a></li>
                                <li><a href="../classes/Services.Events.html">Services.Events</a></li>
                                <li><a href="../classes/Services.Exporter.html">Services.Exporter</a></li>
                                <li><a href="../classes/Services.Feathers.html">Services.Feathers</a></li>
                                <li><a href="../classes/Services.Importer.html">Services.Importer</a></li>
                                <li><a href="../classes/Services.Installer.html">Services.Installer</a></li>
                                <li><a href="../classes/Services.Packager.html">Services.Packager</a></li>
                                <li><a href="../classes/Services.Profile.html">Services.Profile</a></li>
                                <li><a href="../classes/Services.Role.html">Services.Role</a></li>
                                <li><a href="../classes/Services.Routes.html">Services.Routes</a></li>
                                <li><a href="../classes/Services.Services.html">Services.Services</a></li>
                                <li><a href="../classes/Services.Settings.html">Services.Settings</a></li>
                                <li><a href="../classes/Services.Tools.html">Services.Tools</a></li>
                                <li><a href="../classes/Services.Workbooks.html">Services.Workbooks</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/User.html">User</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/API.html">API</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/CRUD.html">CRUD</a></li>
                                <li><a href="../modules/Currency.html">Currency</a></li>
                                <li><a href="../modules/Database.html">Database</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/Date.html">Date</a></li>
                                <li><a href="../modules/Events.html">Events</a></li>
                                <li><a href="../modules/Feathers.html">Feathers</a></li>
                                <li><a href="../modules/Installer.html">Installer</a></li>
                                <li><a href="../modules/IO.html">IO</a></li>
                                <li><a href="../modules/Number.html">Number</a></li>
                                <li><a href="../modules/Packager.html">Packager</a></li>
                                <li><a href="../modules/Profile.html">Profile</a></li>
                                <li><a href="../modules/Role.html">Role</a></li>
                                <li><a href="../modules/Routes.html">Routes</a></li>
                                <li><a href="../modules/Settings.html">Settings</a></li>
                                <li><a href="../modules/String.html">String</a></li>
                                <li><a href="../modules/Tools.html">Tools</a></li>
                                <li><a href="../modules/Workbooks.html">Workbooks</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: services\currency.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint node*/
/**
    @module Currency
*/
/**
    @class Money
    @static
*/
/**
    @property currency
    @type String
*/
/**
    @property amount
    @type Number
*/
/**
    Conversion date
    @property effective
    @type String
    @optional
*/
/**
    Amount in base currency
    @property baseAmmount
    @type Number
    @optional
*/
(function (exports) {
    &quot;use strict&quot;;

    const {Database} = require(&quot;../database&quot;);
    const {Events} = require(&quot;./events&quot;);
    const {Tools} = require(&quot;./tools&quot;);
    const Big = require(&quot;../../node_modules/big.js/big.js&quot;);

    const db = new Database();
    const events = new Events();
    const tools = new Tools();
    const f = require(&quot;../../common/core&quot;);

    let baseCurrs;
    let currencies;

    function byEffective(a, b) {
        let aEffect = a.effective;
        let bEffect = b.effective;

        return (
            aEffect &gt; bEffect
            ? -1
            : 1
        );
    }

    // Get currency info and listen for any subsequent changes
    function init() {
        return new Promise(function (resolve, reject) {
            let id;

            function getCurrencies(obj) {
                return new Promise(function (resolve, reject) {
                    let sql;

                    sql = &quot;SELECT to_json(_currency) AS result &quot;;
                    sql += &quot;FROM _currency;&quot;;

                    function callback(resp) {
                        currencies = tools.sanitize(resp.rows).map(
                            (row) =&gt; row.result
                        );
                        resolve(obj);
                    }

                    obj.client.query(sql).then(callback).catch(reject);
                });
            }

            function getBaseCurrencies(obj) {
                return new Promise(function (resolve, reject) {
                    let sql;

                    sql = &quot;SELECT to_json(_base_currency) AS result &quot;;
                    sql += &quot;FROM _base_currency;&quot;;

                    function callback(resp) {
                        baseCurrs = tools.sanitize(resp.rows).map(
                            (row) =&gt; row.result
                        );
                        resolve(obj);
                    }

                    obj.client.query(sql).then(callback).catch(reject);
                });
            }

            function receiver(message) {
                let found;
                let data = message.payload.data;
                let change = message.payload.subscription.change;

                // Handle change to currency
                if (data.objectType === &quot;Currency&quot;) {
                    if (change === &quot;create&quot;) {
                        currencies.push(data);
                    } else {
                        found = currencies.find(
                            (currency) =&gt; currency.id === data.id
                        );

                        if (change === &quot;delete&quot;) {
                            currencies.splice(currencies.indexOf(found), 1);
                        } else {
                            currencies.splice(
                                currencies.indexOf(found),
                                1,
                                data
                            );
                        }
                    }
                // Base currency records only ever get added
                } else {
                    baseCurrs.push(data);
                }
            }

            function subscribe(obj) {
                return new Promise(function (resolve, reject) {
                    let ids;
                    let subscription;

                    id = db.nodeId + &quot;$currency&quot;;

                    // Subscribe to changes to currency and new records
                    ids = currencies.map((currency) =&gt; currency.id);
                    ids.push(&quot;currency&quot;);
                    ids.push(&quot;base_currency&quot;);

                    subscription = {
                        nodeId: id,
                        eventKey: id,
                        id: id
                    };

                    events.subscribe(
                        obj.client,
                        subscription,
                        ids
                    ).then(
                        resolve.bind(null, obj)
                    ).catch(
                        reject
                    );
                });
            }

            function listen(obj) {
                return new Promise(function (resolve, reject) {
                    events.listen(
                        obj.client,
                        id,
                        receiver
                    ).then(
                        resolve
                    ).catch(
                        reject
                    );
                });
            }

            // Note the client stays open here listening for events
            Promise.resolve().then(
                db.connect
            ).then(
                getCurrencies
            ).then(
                getBaseCurrencies
            ).then(
                subscribe
            ).then(
                listen
            ).then(
                resolve
            ).catch(
                reject
            );
        });
    }

    /**
        Currency conversion service.

        @class Currency
        @constructor
        @namespace Services
    */
    exports.Currency = function () {
        // ..........................................................
        // PUBLIC
        //

        let that = {};

        /**
            Resolves to a base currency object based on an effective date.

            @method baseCurrency
            @param {Object} [payload] Payload
            @param {String} [payload.data] Arguments.
            @param {String} [payload.data.effective] ISO formatted date.
                Default today.
            @return {Promise} Resolves to base currency record.
        */
        that.baseCurrency = function (obj) {
            return new Promise(function (resolve, reject) {
                let effective = (
                    obj.data.effective
                    ? new Date(obj.data.effective).toDate()
                    : new Date()
                );

                function calculate() {
                    let current;
                    let baseCurr;

                    baseCurrs.sort(byEffective);
                    current = baseCurrs.find(function (item) {
                        return new Date(item.effective) &lt;= effective;
                    });

                    if (!current) {
                        current = baseCurrs[baseCurrs.length - 1];
                    }

                    current = current.currency.code;

                    baseCurr = currencies.find(function (currency) {
                        return currency.code === current;
                    });

                    resolve(baseCurr);
                }

                if (baseCurrs) {
                    calculate();
                    return;
                }

                init(obj).then(
                    calculate
                ).catch(
                    reject
                );
            });
        };

        /**
            Resolves to a base currency money object populated with the base
            currency amount.

            @method convertCurrency
            @param {Object} payload Payload
            @param {Client} payload.client Database client
            @param {Object} payload.data Arguments
            @param {String} payload.data.fromCurrency Currency code from
            @param {Number} payload.data.amount Amount
            @param {String} [payload.data.toCurrency] Target currency code.
                Default base.
            @param {String} [payload.data.effective] ISO formatted date.
                Default today.
            @return {Promise} Resolves to {{#crossLink &quot;Money&quot;}}{{/crossLink}}
        */
        that.convertCurrency = function (obj) {
            return new Promise(function (resolve, reject) {
                let baseCurr;
                let err;
                let effective;
                let fromCurr = obj.data.fromCurrency;
                let fromAmount = obj.data.amount;
                let msg;
                let client = db.getClient(obj.client);

                // Advance date to next day so we get latest conversion for
                // that day
                effective = (
                    f.parseDate(obj.data.effective || f.today()).toDate()
                );
                effective.setDate(effective.getDate() + 1);

                if (obj.data.toCurrency) {
                    msg = &quot;Conversion to a specific currency is not&quot;;
                    msg += &quot;implemented yet.&quot;;
                    err = new Error(msg);
                    err.statusCode = &quot;501&quot;;
                    reject(err);
                    return;
                }

                function calculate(resp) {
                    let conv;
                    let amount;

                    if (!resp.rows.length) {
                        msg = &quot;Conversion not found for &quot;;
                        msg += fromCurr + &quot; to &quot; + baseCurr.code + &quot; on &quot;;
                        msg += effective.toLocaleString();
                        err = new Error(msg);
                        err.statusCode = &quot;404&quot;;
                        reject(err);
                        return;
                    }

                    conv = tools.sanitize(resp.rows[0]);
                    if (conv.fromCurrency.code === baseCurr.code) {
                        amount = new Big(
                            fromAmount
                        ).div(
                            conv.ratio
                        ).round(
                            baseCurr.minorUnit
                        ).valueOf() - 0;
                    } else {
                        amount = new Big(
                            fromAmount
                        ).times(
                            conv.ratio
                        ).round(
                            baseCurr.minorUnit
                        ).valueOf() - 0;
                    }

                    resolve({
                        currency: baseCurr.code,
                        amount: amount,
                        effective: undefined,
                        baseAmount: undefined
                    });
                }

                function getConversion(resp) {
                    let sql;
                    let params;

                    baseCurr = resp;

                    // If already base currency, just return
                    if (fromCurr === baseCurr.code) {
                        resolve({
                            currency: fromCurr,
                            amount: fromAmount,
                            effective: undefined,
                            baseAmount: undefined
                        });
                        return;
                    }

                    sql = &quot;SELECT * FROM _currency_conversion &quot;;
                    sql += &quot;WHERE (from_currency).code IN ($1, $2) &quot;;
                    sql += &quot;AND (to_currency).code IN ($1,$2) &quot;;
                    sql += &quot;AND effective &lt; $3 &quot;;
                    sql += &quot;ORDER BY effective DESC &quot;;
                    sql += &quot;LIMIT 1;&quot;;

                    params = [
                        fromCurr,
                        baseCurr.code,
                        effective.toISOString()
                    ];

                    client.query(sql, params).then(
                        calculate
                    ).catch(
                        reject
                    );
                }

                that.baseCurrency({
                    data: {
                        effective: effective
                    }
                }).then(
                    getConversion
                ).catch(
                    reject
                );
            });
        };


        return that;
    };

}(exports));


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
