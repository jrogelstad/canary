<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>components\relation-widget.js - Featherbone Client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-client.png" title="Featherbone Client"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Catalog.html">Catalog</a></li>
                                <li><a href="../classes/Components.AccountMenu.html">Components.AccountMenu</a></li>
                                <li><a href="../classes/Components.AddressRelation.html">Components.AddressRelation</a></li>
                                <li><a href="../classes/Components.AutoNumber.html">Components.AutoNumber</a></li>
                                <li><a href="../classes/Components.Button.html">Components.Button</a></li>
                                <li><a href="../classes/Components.Checkbox.html">Components.Checkbox</a></li>
                                <li><a href="../classes/Components.ChildFormPage.html">Components.ChildFormPage</a></li>
                                <li><a href="../classes/Components.ChildTable.html">Components.ChildTable</a></li>
                                <li><a href="../classes/Components.ContactRelation.html">Components.ContactRelation</a></li>
                                <li><a href="../classes/Components.DataList.html">Components.DataList</a></li>
                                <li><a href="../classes/Components.DataType.html">Components.DataType</a></li>
                                <li><a href="../classes/Components.Dialog.html">Components.Dialog</a></li>
                                <li><a href="../classes/Components.FilterDialog.html">Components.FilterDialog</a></li>
                                <li><a href="../classes/Components.FormDialog.html">Components.FormDialog</a></li>
                                <li><a href="../classes/Components.FormPage.html">Components.FormPage</a></li>
                                <li><a href="../classes/Components.FormWidget.html">Components.FormWidget</a></li>
                                <li><a href="../classes/Components.MoneyRelation.html">Components.MoneyRelation</a></li>
                                <li><a href="../classes/Components.NavigatorMenu.html">Components.NavigatorMenu</a></li>
                                <li><a href="../classes/Components.RelationWidget.html">Components.RelationWidget</a></li>
                                <li><a href="../classes/Components.SearchInput.html">Components.SearchInput</a></li>
                                <li><a href="../classes/Components.SearchPage.html">Components.SearchPage</a></li>
                                <li><a href="../classes/Components.SettingsPage.html">Components.SettingsPage</a></li>
                                <li><a href="../classes/Components.SortDialog.html">Components.SortDialog</a></li>
                                <li><a href="../classes/Components.TableDialog.html">Components.TableDialog</a></li>
                                <li><a href="../classes/Components.TableWidget.html">Components.TableWidget</a></li>
                                <li><a href="../classes/Components.WorkbookPage.html">Components.WorkbookPage</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/Date.html">Date</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/List.html">List</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/Models.Address.html">Models.Address</a></li>
                                <li><a href="../classes/Models.BaseCurrency.html">Models.BaseCurrency</a></li>
                                <li><a href="../classes/Models.Comment.html">Models.Comment</a></li>
                                <li><a href="../classes/Models.Contact.html">Models.Contact</a></li>
                                <li><a href="../classes/Models.ContactAddress.html">Models.ContactAddress</a></li>
                                <li><a href="../classes/Models.ContactEmail.html">Models.ContactEmail</a></li>
                                <li><a href="../classes/Models.ContactPhone.html">Models.ContactPhone</a></li>
                                <li><a href="../classes/Models.ContactSocialAccount.html">Models.ContactSocialAccount</a></li>
                                <li><a href="../classes/Models.Country.html">Models.Country</a></li>
                                <li><a href="../classes/Models.Currency.html">Models.Currency</a></li>
                                <li><a href="../classes/Models.CurrencyConversion.html">Models.CurrencyConversion</a></li>
                                <li><a href="../classes/Models.CurrencyUnit.html">Models.CurrencyUnit</a></li>
                                <li><a href="../classes/Models.CurrencyUnitConversion.html">Models.CurrencyUnitConversion</a></li>
                                <li><a href="../classes/Models.DataListOption.html">Models.DataListOption</a></li>
                                <li><a href="../classes/Models.DataService.html">Models.DataService</a></li>
                                <li><a href="../classes/Models.Document.html">Models.Document</a></li>
                                <li><a href="../classes/Models.Feather.html">Models.Feather</a></li>
                                <li><a href="../classes/Models.FeatherAuthorization.html">Models.FeatherAuthorization</a></li>
                                <li><a href="../classes/Models.FeatherOverload.html">Models.FeatherOverload</a></li>
                                <li><a href="../classes/Models.FeatherProperty.html">Models.FeatherProperty</a></li>
                                <li><a href="../classes/Models.Form.html">Models.Form</a></li>
                                <li><a href="../classes/Models.FormAttr.html">Models.FormAttr</a></li>
                                <li><a href="../classes/Models.FormAttrColumn.html">Models.FormAttrColumn</a></li>
                                <li><a href="../classes/Models.FormTab.html">Models.FormTab</a></li>
                                <li><a href="../classes/Models.Honorific.html">Models.Honorific</a></li>
                                <li><a href="../classes/Models.Kind.html">Models.Kind</a></li>
                                <li><a href="../classes/Models.Layout.html">Models.Layout</a></li>
                                <li><a href="../classes/Models.Log.html">Models.Log</a></li>
                                <li><a href="../classes/Models.Module.html">Models.Module</a></li>
                                <li><a href="../classes/Models.ModuleDependency.html">Models.ModuleDependency</a></li>
                                <li><a href="../classes/Models.Object.html">Models.Object</a></li>
                                <li><a href="../classes/Models.ObjectAuthorization.html">Models.ObjectAuthorization</a></li>
                                <li><a href="../classes/Models.RelationSearchColumn.html">Models.RelationSearchColumn</a></li>
                                <li><a href="../classes/Models.RelationWidget.html">Models.RelationWidget</a></li>
                                <li><a href="../classes/Models.Role.html">Models.Role</a></li>
                                <li><a href="../classes/Models.RoleMembership.html">Models.RoleMembership</a></li>
                                <li><a href="../classes/Models.Route.html">Models.Route</a></li>
                                <li><a href="../classes/Models.Script.html">Models.Script</a></li>
                                <li><a href="../classes/Models.SocialNetwork.html">Models.SocialNetwork</a></li>
                                <li><a href="../classes/Models.State.html">Models.State</a></li>
                                <li><a href="../classes/Models.Style.html">Models.Style</a></li>
                                <li><a href="../classes/Models.Unit.html">Models.Unit</a></li>
                                <li><a href="../classes/Models.UserAccount.html">Models.UserAccount</a></li>
                                <li><a href="../classes/Models.Workbook.html">Models.Workbook</a></li>
                                <li><a href="../classes/Models.WorkbookAuthorization.html">Models.WorkbookAuthorization</a></li>
                                <li><a href="../classes/Models.WorkbookChild.html">Models.WorkbookChild</a></li>
                                <li><a href="../classes/Models.WorkbookDefaultConfig.html">Models.WorkbookDefaultConfig</a></li>
                                <li><a href="../classes/Models.WorkbookLocalConfig.html">Models.WorkbookLocalConfig</a></li>
                                <li><a href="../classes/Number.html">Number</a></li>
                                <li><a href="../classes/Property.html">Property</a></li>
                                <li><a href="../classes/State.html">State</a></li>
                                <li><a href="../classes/State.define.html">State.define</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/ViewModels.AccountMenu.html">ViewModels.AccountMenu</a></li>
                                <li><a href="../classes/ViewModels.AddressRelation.html">ViewModels.AddressRelation</a></li>
                                <li><a href="../classes/ViewModels.AutoNumber.html">ViewModels.AutoNumber</a></li>
                                <li><a href="../classes/ViewModels.Button.html">ViewModels.Button</a></li>
                                <li><a href="../classes/ViewModels.Checkbox.html">ViewModels.Checkbox</a></li>
                                <li><a href="../classes/ViewModels.ChildFormPage.html">ViewModels.ChildFormPage</a></li>
                                <li><a href="../classes/ViewModels.ChildTable.html">ViewModels.ChildTable</a></li>
                                <li><a href="../classes/ViewModels.ContactRelation.html">ViewModels.ContactRelation</a></li>
                                <li><a href="../classes/ViewModels.DataList.html">ViewModels.DataList</a></li>
                                <li><a href="../classes/ViewModels.DataType.html">ViewModels.DataType</a></li>
                                <li><a href="../classes/ViewModels.Dialog.html">ViewModels.Dialog</a></li>
                                <li><a href="../classes/ViewModels.FilterDialog.html">ViewModels.FilterDialog</a></li>
                                <li><a href="../classes/ViewModels.FormDialog.html">ViewModels.FormDialog</a></li>
                                <li><a href="../classes/ViewModels.FormPage.html">ViewModels.FormPage</a></li>
                                <li><a href="../classes/ViewModels.FormWidget.html">ViewModels.FormWidget</a></li>
                                <li><a href="../classes/ViewModels.MoneyRelation.html">ViewModels.MoneyRelation</a></li>
                                <li><a href="../classes/ViewModels.NavigatorMenu.html">ViewModels.NavigatorMenu</a></li>
                                <li><a href="../classes/ViewModels.RelationWidget.html">ViewModels.RelationWidget</a></li>
                                <li><a href="../classes/ViewModels.SearchInput.html">ViewModels.SearchInput</a></li>
                                <li><a href="../classes/ViewModels.SearchPage.html">ViewModels.SearchPage</a></li>
                                <li><a href="../classes/ViewModels.SettingsPage.html">ViewModels.SettingsPage</a></li>
                                <li><a href="../classes/ViewModels.SortDialog.html">ViewModels.SortDialog</a></li>
                                <li><a href="../classes/ViewModels.TableDialog.html">ViewModels.TableDialog</a></li>
                                <li><a href="../classes/ViewModels.TableWidget.html">ViewModels.TableWidget</a></li>
                                <li><a href="../classes/ViewModels.WorkbookPage.html">ViewModels.WorkbookPage</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/AccountMenu.html">AccountMenu</a></li>
                                <li><a href="../modules/AddressRelation.html">AddressRelation</a></li>
                                <li><a href="../modules/AutoNumber.html">AutoNumber</a></li>
                                <li><a href="../modules/Button.html">Button</a></li>
                                <li><a href="../modules/Catalog.html">Catalog</a></li>
                                <li><a href="../modules/Checkbox.html">Checkbox</a></li>
                                <li><a href="../modules/ChildFormPage.html">ChildFormPage</a></li>
                                <li><a href="../modules/ChildTable.html">ChildTable</a></li>
                                <li><a href="../modules/ContactRelation.html">ContactRelation</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/DataList.html">DataList</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/DataType.html">DataType</a></li>
                                <li><a href="../modules/Date.html">Date</a></li>
                                <li><a href="../modules/Dialog.html">Dialog</a></li>
                                <li><a href="../modules/FilterDialog.html">FilterDialog</a></li>
                                <li><a href="../modules/FormDialog.html">FormDialog</a></li>
                                <li><a href="../modules/FormPage.html">FormPage</a></li>
                                <li><a href="../modules/FormWidget.html">FormWidget</a></li>
                                <li><a href="../modules/List.html">List</a></li>
                                <li><a href="../modules/Model.html">Model</a></li>
                                <li><a href="../modules/MoneyRelation.html">MoneyRelation</a></li>
                                <li><a href="../modules/NavigatorMenu.html">NavigatorMenu</a></li>
                                <li><a href="../modules/Number.html">Number</a></li>
                                <li><a href="../modules/Property.html">Property</a></li>
                                <li><a href="../modules/RelationWidget.html">RelationWidget</a></li>
                                <li><a href="../modules/SearchInput.html">SearchInput</a></li>
                                <li><a href="../modules/SearchPage.html">SearchPage</a></li>
                                <li><a href="../modules/SettingsPage.html">SettingsPage</a></li>
                                <li><a href="../modules/SortDialog.html">SortDialog</a></li>
                                <li><a href="../modules/State.html">State</a></li>
                                <li><a href="../modules/String.html">String</a></li>
                                <li><a href="../modules/TableDialog.html">TableDialog</a></li>
                                <li><a href="../modules/TableWidget.html">TableWidget</a></li>
                                <li><a href="../modules/Workbook.html">Workbook</a></li>
                                <li><a href="../modules/WorkbookPage.html">WorkbookPage</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: components\relation-widget.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint this, browser*/
/**
    @module RelationWidget
*/
import f from &quot;../core.js&quot;;

const catalog = f.catalog();
const relationWidget = {};
const m = window.m;

function positionMenu(vnode) {
    let e = document.getElementById(vnode.dom.id);
    let menuRect = e.getBoundingClientRect();
    let pe = &quot;parentElement&quot;; // Keep short for lint;
    let tbl = e[pe][pe][pe][pe][pe][pe];
    let tblRect = tbl.getBoundingClientRect();

    // If menu spills out of table, move up and right
    if (menuRect.bottom &gt; tblRect.bottom) {
        e.style.top = &quot;-60px&quot;;
        e.style.right = &quot;-155px&quot;;
    }
}

/**
    @class RelationWidget
    @constructor
    @namespace ViewModels
    @param {Object} options
    @param {Object} options.parentViewModel Parent view-model. Required
    property &quot;relations&quot; returning javascript object to attach relation
    view model to.
    @param {String} options.parentProperty Name of the relation
    in view model to attached to
    @param {String} options.valueProperty Value property
    @param {Object} [options.form] Form configuration
    @param {Object} [options.list] (Search) List configuration
    @param {Boolean} [options.isCell] Use style for cell in table
    @param {Filter} [options.filter] Filter object used for search
*/
relationWidget.viewModel = function (options) {
    let duplicate;
    let vm = {};
    let registerReceiver;
    let hasFocus = false;
    let parent = options.parentViewModel;
    let parentProperty = options.parentProperty;
    let valueProperty = options.valueProperty;
    let labelProperty = options.labelProperty;
    let modelValue = parent.model().data[parentProperty];
    let current = (
        modelValue()
        ? modelValue().data[valueProperty]()
        : null
    );
    let inputValue = f.prop(current);
    let type = modelValue.type;
    let criteria = (
        options.filter
        ? options.filter.criteria || []
        : []
    );
    let filter = {
        criteria: f.copy(criteria),
        sort: [{
            property: valueProperty
        }],
        limit: 10
    };
    let modelList = f.createList(type.relation, {
        filter: filter
    });
    let configId = f.createId();

    function updateValue(prop) {
        let value = prop();
        if (value) {
            vm.value(value.data[options.valueProperty]());
        } else {
            vm.value(&quot;&quot;);
        }
    }

    // Make sure data changes made by biz logic in the model are
    // recognized
    parent.model().onChanged(parentProperty, updateValue);

    // Because if relation is first focus, no logical way to respond
    // to fetch
    parent.model().state().resolve(&quot;/Ready/Fetched&quot;).enter(
        updateValue.bind(null, parent.model().data[parentProperty])
    );

    /**
        @method listId
        @param {String} id
        @return {String}
    */
    vm.listId = f.prop(f.createId());
    /**
        @method fetch
    */
    vm.fetch = function () {
        vm.models().fetch(filter, false);
    };
    /**
        @method id
        @param {String} id
        @return {String}
    */
    vm.id = f.prop(options.id);
    /**
        @method isCell
        @param {Boolean} flag
        @return {String}
    */
    vm.isCell = f.prop(Boolean(options.isCell));
    /**
        @property isRelationWidget
        @type Boolean
        @default true
    */
    vm.isRelationWidget = true;
    /**
        @method isReadOnly
        @param {Boolean} flag
        @return {Boolean}
    */
    vm.isReadOnly = options.isReadOnly || f.prop(false);
    /**
        @method label
        @return {String}
    */
    vm.label = function () {
        let model = modelValue();
        return (
            (labelProperty &amp;&amp; model)
            ? model.data[labelProperty]()
            : &quot;&quot;
        );
    };
    /**
        @method labelProperty
        @param {String} property
        @return {String}
    */
    vm.labelProperty = f.prop(options.labelProperty);
    /**
        @method labels
        @return {Array}
    */
    vm.labels = function () {
        return [
            m(&quot;div&quot;, {
                class: &quot;fb-input&quot;,
                style: {
                    marginLeft: &quot;12px&quot;,
                    marginTop: (
                        vm.label()
                        ? &quot;6px&quot;
                        : &quot;&quot;
                    )
                }
            }, vm.label())
        ];
    };
    /**
        @method model
        @return {Model}
    */
    vm.model = function () {
        return modelValue();
    };
    /**
        Array of models in selector list.
        @method models
        @return {Array}
    */
    vm.models = function () {
        return modelList;
    };
    /**
        Create new record in form.
        @method new
    */
    vm.new = function () {
        m.route.set(&quot;/edit/:feather/:key&quot;, {
            feather: type.relation.toSpinalCase(),
            key: f.createId()
        }, {
            state: {
                receiver: registerReceiver(),
                create: true
            }
        });
    };
    /**
        Open selected record in form.
        @method open
    */
    vm.open = function () {
        m.route.set(&quot;/edit/:feather/:key&quot;, {
            feather: type.relation.toSpinalCase(),
            key: modelValue().id()
        }, {
            state: {
                receiver: registerReceiver()
            }
        });
    };
    /**
        Open searh page.
        @method search
        @param {Object} filter
    */
    vm.search = function (filter) {
        let searchList = f.copy(options.list);
        searchList.filter = filter || options.filter || searchList.filter;

        catalog.register(&quot;config&quot;, configId, searchList);

        m.route.set(&quot;/search/:feather&quot;, {
            feather: type.relation.toSpinalCase(),
            config: configId
        }, {
            state: {
                receiver: registerReceiver()
            }
        });
    };
    /**
        Handler for auto-complete.
        @method formConfig
        @param {Any} value
    */
    vm.onchange = function (value) {
        let currentModel;
        let currentValue = false;
        let models = vm.models();
        let regexp = new RegExp(&quot;^&quot; + value, &quot;i&quot;);

        function count(counter, model) {
            let mValue = model.data[valueProperty]();

            if (mValue === currentValue) {
                return counter + 1;
            }

            return counter;
        }

        function match(model) {
            currentValue = model.data[valueProperty]();

            if (Array.isArray(currentValue.match(regexp))) {
                currentModel = model;
                return true;
            }

            currentValue = false;
            return false;
        }

        // If multiple matches, launch search to get one exactly
        if (
            value.length &amp;&amp; models.some(match) &amp;&amp;
            models.reduce(count, 0) &gt; 1
        ) {
            duplicate = {
                criteria: [{
                    property: valueProperty,
                    value: currentValue
                }]
            };

            // Avoid mithril error when selecting from data list by
            // letting finish here, then handle search on blur event
            document.getElementById(vm.id()).blur();

            return;
        }

        if (currentValue) {
            modelValue(currentModel);
            inputValue(currentValue);
        } else {
            modelValue(null);
            inputValue(null);
            delete filter.criteria;
            vm.fetch();
        }
    };
    /**
        Handler for onfocus event.
        @method onfocus
    */
    vm.onfocus = function () {
        let value = modelValue();

        hasFocus = true;
        value = (
            value
            ? value.data[options.valueProperty]()
            : null
        );
        inputValue(value);
    };
    /**
        Handler for blur event.
        @method onblur.
    */
    vm.onblur = function () {
        hasFocus = false;

        if (duplicate) {
            vm.search(duplicate);
        }
        duplicate = undefined;
    };
    /**
        Handler for oninput event.
        @method oninput
    */
    vm.oninput = function (value) {
        let fetch = false;
        let inputVal = inputValue() || &quot;&quot;;

        if (
            value.length &lt;= inputVal.length ||
            modelList.length === 10
        ) {
            fetch = true;
        }
        inputValue(value);
        if (fetch) {
            filter.criteria = f.copy(criteria);
            filter.criteria.push({
                property: valueProperty,
                operator: &quot;~*&quot;,
                value: &quot;^&quot; + value
            });
            vm.fetch();
        }
    };
    /**
        Show menu on this event.
        @method onmouseovermenu
    */
    vm.onmouseovermenu = function () {
        vm.showMenu(true);
    };
    /**
        Hide menu on this event.
        @method onmouseoutmenu.
        @param {Event} event
    */
    vm.onmouseoutmenu = function (ev) {
        if (
            !ev || !ev.toElement ||
            !ev.toElement.id ||
            ev.toElement.id.indexOf(
                &quot;nav-relation&quot;
            ) === -1
        ) {
            vm.showMenu(false);
        }
    };
    /**
        @method parentProperty
        @param {String} property
        @return {String}
    */
    vm.parentProperty = f.prop(options.parentProperty);
    /**
        @method parentViewModel
        @param {Object} viewModel
        @return {Object}
    */
    vm.parantViewModel = f.prop(options.parentViewModel);
    /**
        @method showMenu
        @param {Boolean} flag
        @return {Boolean}
    */
    vm.showMenu = f.prop(false);
    /**
        @method style
        @param {Object} style
        @return {Object}
    */
    vm.style = f.prop({});
    /**
        @method formConfig
        @param {Any} value
        @return {Any}
    */
    vm.value = function (...args) {
        let result;
        let value = args[0];

        if (hasFocus) {
            if (args.length) {
                result = inputValue(value);
            } else {
                result = inputValue();
            }
            return result || &quot;&quot;;
        }

        result = modelValue();
        if (!result) {
            return &quot;&quot;;
        }
        return result.data[valueProperty]();
    };
    /**
        @method valueProperty
        @param {String} property
        @return {String}
    */
    vm.valueProperty = f.prop(valueProperty);

    // Helper function for registering callbacks
    registerReceiver = function () {
        let receiverKey = f.createId();

        catalog.register(&quot;receivers&quot;, receiverKey, {
            callback: function (model) {
                modelValue(model);
                vm.showMenu(false);
            }
        });

        return receiverKey;
    };

    vm.style(options.style || {});

    return vm;
};

catalog.register(&quot;viewModels&quot;, &quot;relationWidget&quot;, relationWidget.viewModel);

/**
    @class RelationWidget
    @static
    @namespace Components
*/
relationWidget.component = {
    /**
        @method oninit
        @param {Object} options
        @param {Object} options.viewModel Parent view-model. Must have
        property &quot;relations&quot; returning javascript object to attach relation
        view model to.
        @param {String} options.parentProperty Name of the relation
        in view model to attached to
        @param {String} options.valueProperty Value property
        @param {Boolean} [options.isCell] Use style for cell in table
    */
    oninit: function (vnode) {
        let options = vnode.attrs;
        let parentProperty = options.parentProperty;
        let relations = options.parentViewModel.relations();

        // Set up viewModel if required
        if (!relations[parentProperty]) {
            relations[parentProperty] = relationWidget.viewModel({
                parentViewModel: options.parentViewModel,
                parentProperty: parentProperty,
                valueProperty: options.valueProperty,
                labelProperty: options.labelProperty,
                form: options.form,
                list: options.list,
                filter: options.filter,
                isCell: options.isCell,
                id: options.id,
                isReadOnly: options.isReadOnly,
                style: options.style
            });
        }

        this.viewModel = relations[parentProperty];
    },

    /**
        @method view
        @param {Object} Virtual nodeName
        @return {Object} View
    */
    view: function (vnode) {
        let listOptions;
        let inputStyle;
        let menuStyle;
        let maxWidth;
        let menu;
        let vm = this.viewModel;
        let readonly = vm.isReadOnly();
        let style = vm.style();
        let openMenuClass = &quot;pure-menu-link&quot;;
        let editMenuClass = &quot;pure-menu-link&quot;;
        let buttonClass = &quot;pure-button fa fa-bars fb-relation-button&quot;;
        let labelClass = &quot;fb-relation-label&quot;;
        let id = vm.id();

        menuStyle = {
            display: (
                vm.showMenu()
                ? &quot;block&quot;
                : &quot;none&quot;
            )
        };

        // Generate picker list
        listOptions = vm.models().map(function (model) {
            let content = {
                value: model.data[vm.valueProperty()]()
            };
            if (vm.labelProperty()) {
                content.label = model.data[vm.labelProperty()]();
            }
            return m(&quot;option&quot;, content);
        });

        style.display = style.display || &quot;inline-block&quot;;

        if (!vm.model()) {
            openMenuClass += &quot; pure-menu-disabled&quot;;
        }

        if (readonly) {
            editMenuClass += &quot; pure-menu-disabled&quot;;
        }

        if (vm.isCell()) {
            inputStyle = {
                minWidth: &quot;100px&quot;,
                maxWidth: &quot;100%&quot;
            };
            buttonClass += &quot; fb-relation-button-cell&quot;;
            menuStyle.top = &quot;34px&quot;;
            menuStyle.right = &quot;-100px&quot;;
            labelClass = &quot;fb-relation-label-cell&quot;;

            menu = m(&quot;div&quot;, {
                id: &quot;nav-relation-div-container-&quot; + id,
                onmouseover: vm.onmouseovermenu,
                style: {
                    position: &quot;relative&quot;,
                    display: &quot;inline&quot;
                }
            }, [
                m(&quot;div&quot;, {
                    id: &quot;nav-relation-div-menu-&quot; + id,
                    class: (
                        &quot;pure-menu &quot; +
                        &quot;custom-restricted-width &quot; +
                        &quot;fb-relation-menu&quot;
                    ),
                    onmouseover: vm.onmouseovermenu,
                    onmouseout: vm.onmouseoutmenu
                }, [
                    m(&quot;span&quot;, {
                        id: &quot;nav-relation-span-&quot; + id,
                        class: buttonClass
                    }),
                    m(&quot;ul&quot;, {
                        id: &quot;nav-relation-list-&quot; + id,
                        class: &quot;pure-menu-list fb-relation-menu-list&quot;,
                        style: menuStyle,
                        onupdate: positionMenu
                    }, [
                        m(&quot;li&quot;, {
                            id: &quot;nav-relation-search-&quot; + id,
                            class: editMenuClass,
                            onclick: vm.search
                        }, [m(&quot;i&quot;, {
                            id: &quot;nav-relation-search-icon-&quot; + id,
                            class: &quot;fa fa-search&quot;
                        })], &quot; Search&quot;),
                        m(&quot;li&quot;, {
                            id: &quot;nav-relation-open-&quot; + id,
                            class: openMenuClass,
                            onclick: vm.open
                        }, [m(&quot;i&quot;, {
                            id: &quot;nav-relation-open-icon-&quot; + id,
                            class: &quot;fa fa-folder-open&quot;
                        })], &quot; Open&quot;),
                        m(&quot;li&quot;, {
                            id: &quot;nav-relation-new-&quot; + id,
                            class: editMenuClass,
                            onclick: vm.new
                        }, [m(&quot;i&quot;, {
                            id: &quot;nav-relation-new-icon-&quot; + id,
                            class: &quot;fa fa-plus-circle&quot;
                        })], &quot; New&quot;)
                    ])
                ])
            ]);
        }

        // Hack size to fit button.
        if (style.maxWidth) {
            maxWidth = style.maxWidth.replace(&quot;px&quot;, &quot;&quot;);
            maxWidth = maxWidth - 35;
            maxWidth = (
                maxWidth &lt; 100
                ? 100
                : maxWidth
            );
            inputStyle.maxWidth = maxWidth + &quot;px&quot;;
        }

        // Build the view
        return m(&quot;div&quot;, {
            style: style
        }, [
            m(&quot;input&quot;, {
                style: inputStyle,
                list: vm.listId(),
                id: vm.id(),
                onchange: (e) =&gt; vm.onchange(e.target.value),
                onfocus: vm.onfocus,
                onblur: vm.onblur,
                oninput: (e) =&gt; vm.oninput(e.target.value),
                value: vm.value(),
                oncreate: vnode.attrs.onCreate,
                onremove: vnode.attrs.onRemove,
                readonly: readonly
            }),
            menu,
            m(&quot;div&quot;, {
                class: labelClass
            }, vm.labels()),
            m(&quot;datalist&quot;, {
                id: vm.listId()
            }, listOptions)
        ]);
    }
};

catalog.register(&quot;components&quot;, &quot;relationWidget&quot;, relationWidget.component);

export default Object.freeze(relationWidget);
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
