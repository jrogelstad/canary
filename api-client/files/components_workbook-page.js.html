<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>components\workbook-page.js - Featherbone Client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="..\..\featherbone-client.png" title="Featherbone Client"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Catalog.html">Catalog</a></li>
                                <li><a href="../classes/Components.AccountMenu.html">Components.AccountMenu</a></li>
                                <li><a href="../classes/Components.AddressRelation.html">Components.AddressRelation</a></li>
                                <li><a href="../classes/Components.AutoNumber.html">Components.AutoNumber</a></li>
                                <li><a href="../classes/Components.Button.html">Components.Button</a></li>
                                <li><a href="../classes/Components.Checkbox.html">Components.Checkbox</a></li>
                                <li><a href="../classes/Components.ChildFormPage.html">Components.ChildFormPage</a></li>
                                <li><a href="../classes/Components.ChildTable.html">Components.ChildTable</a></li>
                                <li><a href="../classes/Components.ContactRelation.html">Components.ContactRelation</a></li>
                                <li><a href="../classes/Components.DataList.html">Components.DataList</a></li>
                                <li><a href="../classes/Components.DataType.html">Components.DataType</a></li>
                                <li><a href="../classes/Components.Dialog.html">Components.Dialog</a></li>
                                <li><a href="../classes/Components.FilterDialog.html">Components.FilterDialog</a></li>
                                <li><a href="../classes/Components.FormDialog.html">Components.FormDialog</a></li>
                                <li><a href="../classes/Components.FormPage.html">Components.FormPage</a></li>
                                <li><a href="../classes/Components.FormWidget.html">Components.FormWidget</a></li>
                                <li><a href="../classes/Components.MoneyRelation.html">Components.MoneyRelation</a></li>
                                <li><a href="../classes/Components.NavigatorMenu.html">Components.NavigatorMenu</a></li>
                                <li><a href="../classes/Components.RelationWidget.html">Components.RelationWidget</a></li>
                                <li><a href="../classes/Components.SearchInput.html">Components.SearchInput</a></li>
                                <li><a href="../classes/Components.SearchPage.html">Components.SearchPage</a></li>
                                <li><a href="../classes/Components.SettingsPage.html">Components.SettingsPage</a></li>
                                <li><a href="../classes/Components.SortDialog.html">Components.SortDialog</a></li>
                                <li><a href="../classes/Components.TableDialog.html">Components.TableDialog</a></li>
                                <li><a href="../classes/Components.TableWidget.html">Components.TableWidget</a></li>
                                <li><a href="../classes/Components.WorkbookPage.html">Components.WorkbookPage</a></li>
                                <li><a href="../classes/Datasource.html">Datasource</a></li>
                                <li><a href="../classes/Date.html">Date</a></li>
                                <li><a href="../classes/f.html">f</a></li>
                                <li><a href="../classes/Filter.html">Filter</a></li>
                                <li><a href="../classes/List.html">List</a></li>
                                <li><a href="../classes/Model.html">Model</a></li>
                                <li><a href="../classes/Models.Address.html">Models.Address</a></li>
                                <li><a href="../classes/Models.BaseCurrency.html">Models.BaseCurrency</a></li>
                                <li><a href="../classes/Models.Comment.html">Models.Comment</a></li>
                                <li><a href="../classes/Models.Contact.html">Models.Contact</a></li>
                                <li><a href="../classes/Models.ContactAddress.html">Models.ContactAddress</a></li>
                                <li><a href="../classes/Models.ContactEmail.html">Models.ContactEmail</a></li>
                                <li><a href="../classes/Models.ContactPhone.html">Models.ContactPhone</a></li>
                                <li><a href="../classes/Models.ContactSocialAccount.html">Models.ContactSocialAccount</a></li>
                                <li><a href="../classes/Models.Country.html">Models.Country</a></li>
                                <li><a href="../classes/Models.Currency.html">Models.Currency</a></li>
                                <li><a href="../classes/Models.CurrencyConversion.html">Models.CurrencyConversion</a></li>
                                <li><a href="../classes/Models.CurrencyUnit.html">Models.CurrencyUnit</a></li>
                                <li><a href="../classes/Models.CurrencyUnitConversion.html">Models.CurrencyUnitConversion</a></li>
                                <li><a href="../classes/Models.DataListOption.html">Models.DataListOption</a></li>
                                <li><a href="../classes/Models.DataService.html">Models.DataService</a></li>
                                <li><a href="../classes/Models.Document.html">Models.Document</a></li>
                                <li><a href="../classes/Models.Feather.html">Models.Feather</a></li>
                                <li><a href="../classes/Models.FeatherAuthorization.html">Models.FeatherAuthorization</a></li>
                                <li><a href="../classes/Models.FeatherOverload.html">Models.FeatherOverload</a></li>
                                <li><a href="../classes/Models.FeatherProperty.html">Models.FeatherProperty</a></li>
                                <li><a href="../classes/Models.Form.html">Models.Form</a></li>
                                <li><a href="../classes/Models.FormAttr.html">Models.FormAttr</a></li>
                                <li><a href="../classes/Models.FormAttrColumn.html">Models.FormAttrColumn</a></li>
                                <li><a href="../classes/Models.FormTab.html">Models.FormTab</a></li>
                                <li><a href="../classes/Models.Honorific.html">Models.Honorific</a></li>
                                <li><a href="../classes/Models.Kind.html">Models.Kind</a></li>
                                <li><a href="../classes/Models.Layout.html">Models.Layout</a></li>
                                <li><a href="../classes/Models.Log.html">Models.Log</a></li>
                                <li><a href="../classes/Models.Module.html">Models.Module</a></li>
                                <li><a href="../classes/Models.ModuleDependency.html">Models.ModuleDependency</a></li>
                                <li><a href="../classes/Models.Object.html">Models.Object</a></li>
                                <li><a href="../classes/Models.ObjectAuthorization.html">Models.ObjectAuthorization</a></li>
                                <li><a href="../classes/Models.RelationSearchColumn.html">Models.RelationSearchColumn</a></li>
                                <li><a href="../classes/Models.RelationWidget.html">Models.RelationWidget</a></li>
                                <li><a href="../classes/Models.Role.html">Models.Role</a></li>
                                <li><a href="../classes/Models.RoleMembership.html">Models.RoleMembership</a></li>
                                <li><a href="../classes/Models.Route.html">Models.Route</a></li>
                                <li><a href="../classes/Models.Script.html">Models.Script</a></li>
                                <li><a href="../classes/Models.SocialNetwork.html">Models.SocialNetwork</a></li>
                                <li><a href="../classes/Models.State.html">Models.State</a></li>
                                <li><a href="../classes/Models.Style.html">Models.Style</a></li>
                                <li><a href="../classes/Models.Unit.html">Models.Unit</a></li>
                                <li><a href="../classes/Models.UserAccount.html">Models.UserAccount</a></li>
                                <li><a href="../classes/Models.Workbook.html">Models.Workbook</a></li>
                                <li><a href="../classes/Models.WorkbookAuthorization.html">Models.WorkbookAuthorization</a></li>
                                <li><a href="../classes/Models.WorkbookChild.html">Models.WorkbookChild</a></li>
                                <li><a href="../classes/Models.WorkbookDefaultConfig.html">Models.WorkbookDefaultConfig</a></li>
                                <li><a href="../classes/Models.WorkbookLocalConfig.html">Models.WorkbookLocalConfig</a></li>
                                <li><a href="../classes/Number.html">Number</a></li>
                                <li><a href="../classes/Property.html">Property</a></li>
                                <li><a href="../classes/State.html">State</a></li>
                                <li><a href="../classes/State.define.html">State.define</a></li>
                                <li><a href="../classes/String.html">String</a></li>
                                <li><a href="../classes/ViewModels.AccountMenu.html">ViewModels.AccountMenu</a></li>
                                <li><a href="../classes/ViewModels.AddressRelation.html">ViewModels.AddressRelation</a></li>
                                <li><a href="../classes/ViewModels.AutoNumber.html">ViewModels.AutoNumber</a></li>
                                <li><a href="../classes/ViewModels.Button.html">ViewModels.Button</a></li>
                                <li><a href="../classes/ViewModels.Checkbox.html">ViewModels.Checkbox</a></li>
                                <li><a href="../classes/ViewModels.ChildFormPage.html">ViewModels.ChildFormPage</a></li>
                                <li><a href="../classes/ViewModels.ChildTable.html">ViewModels.ChildTable</a></li>
                                <li><a href="../classes/ViewModels.ContactRelation.html">ViewModels.ContactRelation</a></li>
                                <li><a href="../classes/ViewModels.DataList.html">ViewModels.DataList</a></li>
                                <li><a href="../classes/ViewModels.DataType.html">ViewModels.DataType</a></li>
                                <li><a href="../classes/ViewModels.Dialog.html">ViewModels.Dialog</a></li>
                                <li><a href="../classes/ViewModels.FilterDialog.html">ViewModels.FilterDialog</a></li>
                                <li><a href="../classes/ViewModels.FormDialog.html">ViewModels.FormDialog</a></li>
                                <li><a href="../classes/ViewModels.FormPage.html">ViewModels.FormPage</a></li>
                                <li><a href="../classes/ViewModels.FormWidget.html">ViewModels.FormWidget</a></li>
                                <li><a href="../classes/ViewModels.MoneyRelation.html">ViewModels.MoneyRelation</a></li>
                                <li><a href="../classes/ViewModels.NavigatorMenu.html">ViewModels.NavigatorMenu</a></li>
                                <li><a href="../classes/ViewModels.RelationWidget.html">ViewModels.RelationWidget</a></li>
                                <li><a href="../classes/ViewModels.SearchInput.html">ViewModels.SearchInput</a></li>
                                <li><a href="../classes/ViewModels.SearchPage.html">ViewModels.SearchPage</a></li>
                                <li><a href="../classes/ViewModels.SettingsPage.html">ViewModels.SettingsPage</a></li>
                                <li><a href="../classes/ViewModels.SortDialog.html">ViewModels.SortDialog</a></li>
                                <li><a href="../classes/ViewModels.TableDialog.html">ViewModels.TableDialog</a></li>
                                <li><a href="../classes/ViewModels.TableWidget.html">ViewModels.TableWidget</a></li>
                                <li><a href="../classes/ViewModels.WorkbookPage.html">ViewModels.WorkbookPage</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/AccountMenu.html">AccountMenu</a></li>
                                <li><a href="../modules/AddressRelation.html">AddressRelation</a></li>
                                <li><a href="../modules/AutoNumber.html">AutoNumber</a></li>
                                <li><a href="../modules/Button.html">Button</a></li>
                                <li><a href="../modules/Catalog.html">Catalog</a></li>
                                <li><a href="../modules/Checkbox.html">Checkbox</a></li>
                                <li><a href="../modules/ChildFormPage.html">ChildFormPage</a></li>
                                <li><a href="../modules/ChildTable.html">ChildTable</a></li>
                                <li><a href="../modules/ContactRelation.html">ContactRelation</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/DataList.html">DataList</a></li>
                                <li><a href="../modules/Datasource.html">Datasource</a></li>
                                <li><a href="../modules/DataType.html">DataType</a></li>
                                <li><a href="../modules/Date.html">Date</a></li>
                                <li><a href="../modules/Dialog.html">Dialog</a></li>
                                <li><a href="../modules/FilterDialog.html">FilterDialog</a></li>
                                <li><a href="../modules/FormDialog.html">FormDialog</a></li>
                                <li><a href="../modules/FormPage.html">FormPage</a></li>
                                <li><a href="../modules/FormWidget.html">FormWidget</a></li>
                                <li><a href="../modules/List.html">List</a></li>
                                <li><a href="../modules/Model.html">Model</a></li>
                                <li><a href="../modules/MoneyRelation.html">MoneyRelation</a></li>
                                <li><a href="../modules/NavigatorMenu.html">NavigatorMenu</a></li>
                                <li><a href="../modules/Number.html">Number</a></li>
                                <li><a href="../modules/Property.html">Property</a></li>
                                <li><a href="../modules/RelationWidget.html">RelationWidget</a></li>
                                <li><a href="../modules/SearchInput.html">SearchInput</a></li>
                                <li><a href="../modules/SearchPage.html">SearchPage</a></li>
                                <li><a href="../modules/SettingsPage.html">SettingsPage</a></li>
                                <li><a href="../modules/SortDialog.html">SortDialog</a></li>
                                <li><a href="../modules/State.html">State</a></li>
                                <li><a href="../modules/String.html">String</a></li>
                                <li><a href="../modules/TableDialog.html">TableDialog</a></li>
                                <li><a href="../modules/TableWidget.html">TableWidget</a></li>
                                <li><a href="../modules/Workbook.html">Workbook</a></li>
                                <li><a href="../modules/WorkbookPage.html">WorkbookPage</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: components\workbook-page.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Framework for building object relational database apps
    Copyright (C) 2019  John Rogelstad

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
/*jslint this, browser*/
/**
   @module WorkbookPage
*/
import f from &quot;../core.js&quot;;
import icons from &quot;../icons.js&quot;;

const catalog = f.catalog();
const datasource = f.datasource();
const workbookPage = {};
const sheetConfigureDialog = {};
const m = window.m;
const console = window.console;
const jsonpatch = window.jsonpatch;
const editWorkbookConfig = {
    tabs: [{
        name: &quot;Definition&quot;
    }, {
        name: &quot;Authorizations&quot;
    }],
    attrs: [{
        attr: &quot;name&quot;,
        grid: 1
    }, {
        attr: &quot;description&quot;,
        grid: 1
    }, {
        attr: &quot;icon&quot;,
        dataList: icons,
        grid: 1
    }, {
        attr: &quot;module&quot;,
        dataList: &quot;modules&quot;,
        grid: 1
    }, {
        attr: &quot;authorizations&quot;,
        showLabel: false,
        height: &quot;98px&quot;,
        grid: 2,
        columns: [{
            attr: &quot;role&quot;
        }, {
            label: &quot;Read&quot;,
            attr: &quot;canRead&quot;,
            width: 60
        }, {
            label: &quot;Update&quot;,
            attr: &quot;canUpdate&quot;,
            width: 60
        }]
    }]
};

let profileInvalid = false;

function saveProfile(name, config, dlg) {
    let oldProfile = catalog.store().data().profile();
    let newProfile = f.copy(oldProfile);
    let patch;

    function callback(resp) {
        newProfile.etag = resp;
        catalog.store().data().profile(newProfile);
    }

    if (profileInvalid) {
        return;
    }

    if (oldProfile) {
        if (!newProfile.data.workbooks) {
            newProfile.data.workbooks = {};
        }

        if (config) {
            newProfile.data.workbooks[name] = f.copy(config);
        } else {
            delete newProfile.data.workbooks[name];
        }
        patch = jsonpatch.compare(oldProfile.data, newProfile.data);
        if (patch &amp;&amp; patch.length) {
            datasource.request({
                method: &quot;PATCH&quot;,
                path: &quot;/profile&quot;,
                data: {
                    etag: oldProfile.etag,
                    patch: patch
                }
            }).then(callback).catch(function (err) {
                profileInvalid = true;
                dlg.message(err.message);
                dlg.icon(&quot;window-close&quot;);
                dlg.buttonCancel().hide();
                dlg.show();
            });
        }
    } else if (config) {
        newProfile = {data: {workbooks: {}}};
        newProfile.data.workbooks[name] = f.copy(config);
        datasource.request({
            method: &quot;PUT&quot;,
            path: &quot;/profile&quot;,
            data: newProfile.data
        }).then(callback);
    }
}

// View model for worksheet configuration.
sheetConfigureDialog.viewModel = function (options) {
    options = options || {};
    let vm;
    let tableView;
    let createModel = catalog.store().models().workbookLocalConfig;
    let cache = f.copy(options.parentViewModel.sheet());
    let sheetButtonClass;
    let listButtonClass;
    let sheetTabClass;
    let listTabClass;
    let buttonClass = (
        &quot;pure-button &quot; +
        &quot;fb-group-tab &quot;
    );
    let activeClass = buttonClass + &quot; fb-group-tab-active&quot;;
    let workbook = options.parentViewModel.workbook();

    options.onOk = function () {
        let id = vm.sheetId();
        let sheet = vm.model().toJSON();
        let tw = options.parentViewModel.tableWidget();

        vm.sheet(id, sheet);
        // If we updated current sheet (not new), update list
        if (vm.sheet().id === id) {
            tw.config(sheet.list);
        }
        vm.state().send(&quot;close&quot;);
        saveProfile(
            workbook.data.name(),
            options.parentViewModel.config(),
            options.parentViewModel.confirmDialog()
        );
    };
    options.icon = &quot;table&quot;;
    options.title = &quot;Configure worksheet&quot;;

    // ..........................................................
    // PUBLIC
    //

    vm = f.createViewModel(&quot;TableDialog&quot;, options);
    tableView = vm.content;
    vm.alias = function (attr) {
        let feather = catalog.getFeather(vm.model().data.feather());

        return f.resolveAlias(feather, attr);
    };
    vm.addAttr = function (attr) {
        if (!this.some(vm.hasAttr.bind(attr))) {
            this.push({
                attr: attr
            });
            return true;
        }
    };
    vm.attrs = function () {
        let model = vm.model();
        let feather = catalog.getFeather(model.data.feather());
        let keys = (
            feather
            ? Object.keys(feather.properties)
            : false
        );

        return (
            keys
            ? vm.resolveProperties(feather, keys).sort()
            : []
        );
    };
    vm.config = options.parentViewModel.config;
    vm.content = function () {
        let feathers;
        let forms;
        let d = vm.model().data;
        let ids = vm.ids();
        let nameId = ids.name;
        let featherId = ids.feather;
        let openInNewWindowId = ids.openInNewWindow;
        let formId = ids.form;

        feathers = vm.feathers().map(function (feather) {
            return m(&quot;option&quot;, feather);
        });

        forms = vm.forms().map(function (form) {
            return m(&quot;option&quot;, form);
        });

        return m(&quot;div&quot;, {
            class: &quot;pure-form pure-form-aligned fb-sheet-configure-content&quot;
        }, [
            m(&quot;div&quot;, {
                class: &quot;fb-sheet-configure-tabs&quot;
            }, [
                m(&quot;button&quot;, {
                    id: &quot;sheetButton&quot;,
                    class: sheetButtonClass,
                    onclick: vm.toggleTab
                }, &quot;Sheet&quot;),
                m(&quot;button&quot;, {
                    id: &quot;listButton&quot;,
                    class: listButtonClass,
                    onclick: vm.toggleTab
                }, &quot;Columns&quot;)
            ]),
            m(&quot;div&quot;, {
                class: &quot;fb-sheet-configure-group-box&quot;
            }, [
                m(&quot;div&quot;, {
                    class: sheetTabClass
                }, [
                    m(&quot;div&quot;, {
                        class: &quot;pure-control-group&quot;
                    }, [
                        m(&quot;label&quot;, {
                            for: nameId
                        }, &quot;Name:&quot;),
                        m(&quot;input&quot;, {
                            id: nameId,
                            value: d.name(),
                            required: true,
                            oninput: (e) =&gt; d.name(e.target.value),
                            autofocus: true
                        })
                    ]),
                    m(&quot;div&quot;, {
                        class: &quot;pure-control-group&quot;
                    }, [
                        m(&quot;label&quot;, {
                            for: featherId
                        }, &quot;Feather:&quot;),
                        m(&quot;select&quot;, {
                            id: featherId,
                            value: d.feather(),
                            required: true,
                            oninput: (e) =&gt; d.feather(e.target.value)
                        }, feathers)
                    ]),
                    m(&quot;div&quot;, {
                        class: &quot;pure-control-group&quot;
                    }, [
                        m(&quot;label&quot;, {
                            for: openInNewWindowId
                        }, &quot;Open in New Tab:&quot;),
                        m(f.getComponent(&quot;Checkbox&quot;), {
                            id: openInNewWindowId,
                            value: d.openInNewWindow(),
                            onclick: d.openInNewWindow
                        })
                    ]),
                    m(&quot;div&quot;, {
                        class: &quot;pure-control-group&quot;
                    }, [
                        m(&quot;label&quot;, {
                            for: formId
                        }, &quot;Form:&quot;),
                        m(&quot;select&quot;, {
                            id: formId,
                            value: vm.form(),
                            required: true,
                            oninput: (e) =&gt; vm.form(e.target.value),
                            disabled: forms.length === 0,
                            style: {
                                minWidth: &quot;215px&quot;
                            }
                        }, forms)
                    ])
                ]),
                m(&quot;div&quot;, {
                    class: listTabClass
                }, [
                    tableView()
                ])
            ])
        ]);
    };
    vm.data = function () {
        return vm.model().data.list().data.columns();
    };
    vm.hasAttr = function (item) {
        return item.attr === this;
    };
    vm.feathers = function () {
        let feathers = catalog.store().feathers();
        let result = Object.keys(feathers).filter(function (name) {
            return !feathers[name].isChild &amp;&amp; !feathers[name].isSystem;
        }).sort();

        return result;
    };
    vm.form = function (...args) {
        let forms;
        let form;
        let name = args[0];
        let store = catalog.store();
        let prop = vm.model().data.form;

        if (args.length) {
            forms = store.data().forms();
            form = forms.find(function (row) {
                return row.name === name;
            });
            prop(store.models().form(form));
        }
        return (
            prop()
            ? prop().data.name()
            : &quot;&quot;
        );
    };
    vm.forms = function () {
        let result;
        let forms = catalog.store().data().forms();
        let feather = vm.model().data.feather();

        // Only forms that have matching feather
        result = forms.filter(function (form) {
            return form.feather === feather;
        });

        // Just return names
        result = result.map(function (form) {
            return form.name;
        }).sort();

        return result;
    };
    vm.model = f.prop();
    vm.okDisabled = function () {
        return !vm.model().isValid();
    };
    vm.okTitle = function () {
        return vm.model().lastError();
    };
    vm.sheetId = f.prop(options.sheetId);
    vm.relations = f.prop({});
    vm.reset = function () {
        let model;
        let id = vm.sheetId();

        // Setup local model
        cache = f.copy(vm.sheet(id));
        model = createModel(cache);
        model.onChanged(&quot;form&quot;, m.redraw);
        vm.model(model);
        if (!cache.list.columns.length) {
            vm.add();
        }
        vm.selection(0);

        // Set button orientation
        sheetButtonClass = activeClass;
        listButtonClass = buttonClass;
        sheetTabClass = &quot;&quot;;
        listTabClass = &quot;fb-tabbed-panes-hidden&quot;;
    };
    vm.resolveProperties = function (feather, properties, ary, prefix) {
        prefix = prefix || &quot;&quot;;
        let result = ary || [];

        properties.forEach(function (key) {
            let rfeather;
            let prop = feather.properties[key];
            let isObject = typeof prop.type === &quot;object&quot;;
            let path = prefix + key;

            if (isObject &amp;&amp; prop.type.properties) {
                rfeather = catalog.getFeather(prop.type.relation);
                vm.resolveProperties(
                    rfeather,
                    prop.type.properties,
                    result,
                    path + &quot;.&quot;
                );
            }

            if (
                isObject &amp;&amp; (
                    prop.type.childOf ||
                    prop.type.parentOf ||
                    prop.type.isChild
                )
            ) {
                return;
            }

            result.push(path);
        });

        return result;
    };
    vm.sheet = options.parentViewModel.sheet;
    vm.toggleTab = function () {
        if (sheetTabClass) {
            sheetButtonClass = activeClass;
            listButtonClass = buttonClass;
            sheetTabClass = &quot;&quot;;
            listTabClass = &quot;fb-tabbed-panes-hidden&quot;;
        } else {
            sheetButtonClass = buttonClass;
            listButtonClass = activeClass;
            sheetTabClass = &quot;fb-tabbed-panes-hidden&quot;;
            listTabClass = &quot;&quot;;
        }

        document.getElementById(&quot;sheetButton&quot;).blur();
        document.getElementById(&quot;listButton&quot;).blur();
    };
    vm.workbook = options.parentViewModel.workbook;
    vm.viewHeaderIds = f.prop({
        column: f.createId(),
        label: f.createId()
    });
    vm.viewHeaders = function () {
        let ids = vm.viewHeaderIds();

        return [
            m(&quot;th&quot;, {
                style: {
                    minWidth: &quot;165px&quot;
                },
                id: ids.column
            }, &quot;Column&quot;),
            m(&quot;th&quot;, {
                style: {
                    minWidth: &quot;220px&quot;
                },
                id: ids.label
            }, &quot;Label&quot;)
        ];
    };
    vm.viewRows = function () {
        let view;

        view = vm.items().map(function (item) {
            let row;

            row = m(&quot;tr&quot;, {
                onclick: vm.selection.bind(this, item.index, true),
                style: {
                    backgroundColor: vm.rowColor(item.index)
                }
            }, [
                m(&quot;td&quot;, {
                    style: {
                        minWidth: &quot;165px&quot;,
                        maxWidth: &quot;165px&quot;
                    }
                }, m(&quot;select&quot;, {
                    id: &quot;scdSelect&quot; + item.index,
                    value: item.attr,
                    style: {
                        maxWidth: &quot;165px&quot;
                    },
                    onchange: (e) =&gt;
                    vm.itemChanged.bind(
                        this,
                        item.index,
                        &quot;attr&quot;
                    )(e.target.value)
                }, vm.attrs().map(function (attr) {
                    return m(&quot;option&quot;, {
                        value: attr
                    }, attr.toName());
                }))),
                m(&quot;td&quot;, {
                    style: {
                        minWidth: &quot;220px&quot;,
                        maxWidth: &quot;220px&quot;
                    }
                }, m(&quot;input&quot;, {
                    value: item.label || vm.alias(item.attr),
                    onchange: (e) =&gt;
                    vm.itemChanged.bind(
                        this,
                        item.index,
                        &quot;label&quot;
                    )(e.target.value)
                }))
            ]);

            return row;
        });

        return view;
    };

    // ..........................................................
    // PRIVATE
    //

    vm.ids().name = f.createId();
    vm.ids().feather = f.createId();
    vm.ids().openInNewWindow = f.createId();
    vm.ids().form = f.createId();
    vm.style().width = &quot;510px&quot;;
    vm.reset();

    return vm;
};

sheetConfigureDialog.component = f.getComponent(&quot;TableDialog&quot;);

/**
    Define workbook view model
    @class WorkbookPage
    @constructor
    @namespace ViewModels
    @param {Object} options
    @param {String} options.workbook name
    @param {String} options.key worksheet name
*/
workbookPage.viewModel = function (options) {
    let listState;
    let tableState;
    let searchState;
    let currentSheet;
    let feather;
    let sseState = catalog.store().global().sseState;
    let workbook = catalog.store().workbooks()[
        options.workbook.toCamelCase()
    ];

    if (!workbook) {
        m.route.set(&quot;/home&quot;);
        options.isInvalid = true;
        return;
    }

    let config = workbook.getConfig();
    let the_sheet = config.find(function (sheet) {
        return sheet.name.toSpinalCase() === options.key;
    });

    if (!the_sheet) {
        m.route.set(&quot;/home&quot;);
        options.isInvalid = true;
        return;
    }

    let sheetId = the_sheet.id;
    let receiverKey = f.createId();
    let vm = {};

    // ..........................................................
    // PUBLIC
    //

    /**
        @method buttonClear
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonClear = f.prop();
    /**
        @method buttonDelete
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonDelete = f.prop();
    /**
        @method buttonEdit
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonEdit = f.prop();
    /**
        @method buttonFilter
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonFilter = f.prop();
    /**
        @method buttonNew
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonNew = f.prop();
    /**
        @method buttonRefresh
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonRefresh = f.prop();
    /**
        @method buttonSave
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonSave = f.prop();
    /**
        @method buttonSort
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonSort = f.prop();
    /**
        @method buttonUndo
        @param {ViewModels.Button} button
        @return {ViewModels.Button}
    */
    vm.buttonUndo = f.prop();
    /**
        Layout configuration.
        @method config
        @param {Object} config
        @return {Object}
    */
    vm.config = f.prop(config);
    /**
        @method confirmDialog
        @param {ViewModels.Dialog} dialog
        @return {ViewModels.Dialog}
    */
    vm.confirmDialog = f.prop(f.createViewModel(&quot;Dialog&quot;, {
        icon: &quot;question-circle&quot;,
        title: &quot;Confirmation&quot;
    }));
    /**
        Open worksheet configuration dialog.
        @method configureSheet
    */
    vm.configureSheet = function () {
        let dlg = vm.sheetConfigureDialog();
        dlg.onCancel(undefined);
        dlg.sheetId(sheetId);
        dlg.show();
    };
    /**
        @method footerId
        @param {String} id
        @return {String}
    */
    vm.footerId = f.prop(f.createId());
    /**
        Drop event handler for deleting sheets.
        @method deleteSheet
        @param {Event} event
    */
    vm.deleteSheet = function (ev) {
        let doDelete;
        let idx = ev.dataTransfer.getData(&quot;text&quot;) - 0;
        let confirmDialog = vm.confirmDialog();

        doDelete = function () {
            let activeSheetId = vm.sheet().id;
            let deleteSheetId = vm.config()[idx].id;

            vm.config().splice(idx, 1);
            if (activeSheetId === deleteSheetId) {
                if (idx === vm.config().length) {
                    idx -= 1;
                }
                vm.tabClicked(config[idx].name);
            }
            vm.saveProfile();
        };

        confirmDialog.message(
            &quot;Are you sure you want to delete this sheet?&quot;
        );
        confirmDialog.icon(&quot;question-circle&quot;);
        confirmDialog.onOk(doDelete);
        confirmDialog.show();
    };
    /**
        Editor dialog for workbook.
        @method editWorkbookDialog
        @param {ViewModels.Dialog} dialog
        @return {ViewModels.Dialog}
    */
    vm.editWorkbookDialog = f.prop();
    /**
        @method filter
        @param {Filter} filter
        @return {Filter}
    */
    vm.filter = f.prop();
    /**
        @method filterDialog
        @param {ViewModels.FilterDialog} dialog
        @return {ViewModels.FilterDialog}
    */
    vm.filterDialog = f.prop();
    /**
        @method goHome
    */
    vm.goHome = function () {
        m.route.set(&quot;/home&quot;);
    };
    /**
        @method goSignOut
    */
    vm.goSignOut = function () {
        f.state().send(&quot;signOut&quot;);
    };
    /**
        @method goSettings
    */
    vm.goSettings = function () {
        m.route.set(&quot;/settings/:settings&quot;, {
            settings: workbook.data.launchConfig().settings
        });
    };
    /**
        @method isDraggingTab
        @param {Boolean} flag
        @return {Boolean}
    */
    vm.isDraggingTab = f.prop(false);
    /**
        @method hasSettings
        @param {Boolean} flag
        @return {Boolean}
    */
    vm.hasSettings = f.prop(
        Boolean(workbook.data.launchConfig().settings)
    );
    /**
        Create a new model in form, tab or row depending on state.
        @method modelNew
    */
    vm.modelNew = function () {
        let form = vm.sheet().form || {};
        let url;
        let win;

        if (vm.sheet().openInNewWindow) {
            url = (
                window.location.protocol + &quot;//&quot; +
                window.location.hostname + &quot;:&quot; +
                window.location.port + &quot;#!/edit/&quot; +
                feather.name.toSpinalCase() + &quot;/&quot; +
                f.createId()
            );

            win = window.open(url);
            win.options = {
                form: form.id,
                create: true,
                isNewWindow: true
            };
            win.receiver = function (model) {
                // If model came from other window now closed it&#x27;s
                // unstable, so rebuild it
                let nmodel = f.createModel(model.name, model.toJSON());

                nmodel.state().goto(&quot;/Ready/Fetched/Clean&quot;);
                nmodel.checkDelete();
                vm.tableWidget().models().add(nmodel, true);
                m.redraw();
            };
            return;
        }

        if (!vm.tableWidget().modelNew()) {
            m.route.set(&quot;/edit/:feather/:key&quot;, {
                feather: feather.name.toSpinalCase(),
                key: f.createId()
            }, {
                state: {
                    form: form.id,
                    receiver: receiverKey,
                    create: true
                }
            });
        }
    };
    /**
        Open model in form.
        @method openModel
    */
    vm.modelOpen = function () {
        let selection = vm.tableWidget().selection();
        let sheet = vm.sheet() || {};
        let form = sheet.form || {};
        let type = vm.tableWidget().model().data.objectType();
        let url;
        let win;

        if (vm.sheet().openInNewWindow) {
            url = (
                window.location.protocol + &quot;//&quot; +
                window.location.hostname + &quot;:&quot; +
                window.location.port + &quot;#!/edit/&quot; + type + &quot;/&quot; +
                selection.id()
            );

            win = window.open(url);
            win.options = {
                form: form.id,
                isNewWindow: true
            };
            return;
        }

        if (selection) {
            m.route.set(&quot;/edit/:feather/:key&quot;, {
                feather: type,
                key: selection.id()
            }, {
                state: {
                    form: form.id,
                    receiver: receiverKey
                }
            });
        }
    };
    /**
        @method menu
        @param {ViewModels.NavigatorMenu} navigator
        @return {ViewModels.NavigatorMenu}
    */
    vm.menu = f.prop(f.createViewModel(&quot;NavigatorMenu&quot;));
    /**
        Add a new sheet to the workbook.
        @method newSheet
    */
    vm.newSheet = function () {
        let undo;
        let newSheet;
        let sheetName;
        let next;
        let dialogSheetConfigure = vm.sheetConfigureDialog();
        let id = f.createId();
        let sheets = vm.sheets();
        let sheet = f.copy(vm.sheet());
        let i = 0;

        while (!sheetName) {
            i += 1;
            next = &quot;Sheet&quot; + i;
            if (sheets.indexOf(next) === -1) {
                sheetName = next;
            }
        }

        i = 0;

        newSheet = {
            id: id,
            name: sheetName,
            feather: sheet.feather,
            list: {
                columns: sheet.list.columns
            }
        };

        undo = function () {
            vm.config().pop();
            dialogSheetConfigure.onCancel(undefined);
        };

        vm.config().push(newSheet);
        dialogSheetConfigure.sheetId(id);
        dialogSheetConfigure.onCancel(undo);
        dialogSheetConfigure.show();
    };
    /**
        @method ondragend
    */
    vm.ondragend = function () {
        vm.isDraggingTab(false);
    };
    /**
        @method ondragover
        @param {Event} event
    */
    vm.ondragover = function (ev) {
        ev.preventDefault();
    };
    /**
        @method ondragstart
        @param {Integer} index
        @param {Event} event
    */
    vm.ondragstart = function (idx, ev) {
        vm.isDraggingTab(true);
        ev.dataTransfer.setData(&quot;text&quot;, idx);
    };
    /**
        @method ondrop
        @param {Integer} index
        @param {Array} ary
        @param {Event} event
    */
    vm.ondrop = function (toIdx, ary, ev) {
        let moved;
        let fromIdx;

        ev.preventDefault();
        fromIdx = ev.dataTransfer.getData(&quot;text&quot;) - 0;
        if (fromIdx !== toIdx) {
            moved = ary.splice(fromIdx, 1)[0];
            ary.splice(toIdx, 0, moved);
            vm.saveProfile();
        }
        vm.isDraggingTab(false);
    };
    /**
        Handle keyboard up and down keys.
        @method onkeydown
        @param {Event} event
    */
    vm.onkeydown = function (ev) {
        let key = ev.key || ev.keyIdentifier;

        switch (key) {
        case &quot;Up&quot;:
        case &quot;ArrowUp&quot;:
            vm.tableWidget().goPrevRow();
            break;
        case &quot;Down&quot;:
        case &quot;ArrowDown&quot;:
            vm.tableWidget().goNextRow();
            break;
        }
    };
    /**
        Handle on click of actions menu.
        @method onclickactions
    */
    vm.onclickactions = function () {
        vm.showActions(true);
    };
    /**
        Hide actions menu if mouse out.
        @method onmouseoutactions
        @param {Event} event
    */
    vm.onmouseoutactions = function (ev) {
        if (
            !ev || !ev.toElement || !ev.toElement.id ||
            ev.toElement.id.indexOf(&quot;nav-actions&quot;) === -1
        ) {
            vm.showActions(false);
        }
    };
    /**
        Handle on click of workbook menu.
        @method onclickmenu
    */
    vm.onclickmenu = function () {
        vm.showMenu(!vm.showMenu());
    };
    /**
        Hide workbook menu if mouse out.
        @method onmouseoutactions
        @param {Event} event
    */
    vm.onmouseoutmenu = function (ev) {
        if (
            !ev || !ev.toElement || !ev.toElement.id ||
            ev.toElement.id.indexOf(&quot;nav-menu&quot;) === -1
        ) {
            vm.showMenu(false);
        }
    };
    /**
        Requery list.
        @method refresh
    */
    vm.refresh = function () {
        vm.tableWidget().refresh();
    };
    /**
        Revert selected model if dirty.
        @method revert
    */
    vm.revert = function () {
        saveProfile(workbook.data.name(), undefined, vm.confirmDialog());
        document.location.reload();
    };
    /**
        Save user workbook configuration to server.
        @method saveProfile
    */
    vm.saveProfile = function () {
        saveProfile(
            workbook.data.name(),
            vm.config(),
            vm.confirmDialog()
        );
    };
    /**
        @method searchInput
        @param {ViewModels.SearchInput} input
        @return {ViewModels.SearchInput}
    */
    vm.searchInput = f.prop();
    /**
        Make user&#x27;s model configuration the new default.
        @method share
    */
    vm.share = function () {
        let doShare;
        let confirmDialog = vm.confirmDialog();

        doShare = function () {
            let d = f.copy(vm.config());
            workbook.data.localConfig(d);
            workbook.save();
        };

        confirmDialog.message(
            &quot;Are you sure you want to share your workbook &quot; +
            &quot;configuration with all other users?&quot;
        );
        confirmDialog.icon(&quot;question-circle&quot;);
        confirmDialog.onOk(doShare);
        confirmDialog.show();
    };
    /**
        Return sheet configuration. Passing &#x60;value&#x60; will set
        the sheet to the configuration of &#x60;value&#x60;.
        @method sheet
        @param {Object | String} id
        @param {Object} value
        @return {Object} sheet
    */
    vm.sheet = function (id, value) {
        let idx = 0;

        if (id) {
            if (typeof id === &quot;object&quot;) {
                value = id;
                id = sheetId;
            }
        } else {
            id = sheetId;
        }

        if (currentSheet &amp;&amp; currentSheet.id === id &amp;&amp; !value) {
            return currentSheet;
        }

        config.some(function (item) {
            if (id === item.id) {
                return true;
            }
            idx += 1;
        });
        if (value) {
            vm.config().splice(idx, 1, value);
        }
        currentSheet = vm.config()[idx];

        return currentSheet;
    };
    /**
        Return an array of sheet names.
        @method sheets
        @return {Array}
    */
    vm.sheets = function () {
        return vm.config().map(function (sheet) {
            return sheet.name;
        });
    };
    /**
        @method sheetConfigureDialog
        @param {ViewModels.Dialog} dialog
        @return {ViewModels.Dialog}
    */
    vm.sheetConfigureDialog = f.prop();
    /**
        @method showFilterDialog
    */
    vm.showFilterDialog = function () {
        if (vm.tableWidget().models().canFilter()) {
            vm.filterDialog().show();
        }
    };
    /**
        @method showActions
        @param {Boolean} flag
        @return {Boolean}
    */
    vm.showActions = f.prop(false);
    /**
        @method showMenu
        @param {Boolean} flag
        @return {Boolean}
    */
    vm.showMenu = f.prop(false);
    /**
        @method showSortDialog
    */
    vm.showSortDialog = function () {
        if (vm.tableWidget().models().canFilter()) {
            vm.sortDialog().show();
        }
    };
    /**
        @method sortDialog
        @param {ViewModels.SortDialog} dialog
        @return {ViewModels.SortDialog}
    */
    vm.sortDialog = f.prop();
    /**
        Dialog for handling server side events.
        @method sseDialog
        @param {ViewModels.Dialog} dialog
        @return {ViewModels.Dialog}
    */
    vm.sseErrorDialog = f.prop(f.createViewModel(&quot;Dialog&quot;, {
        icon: &quot;window-close&quot;,
        title: &quot;Connection Error&quot;,
        message: (
            &quot;You have lost connection to the server. &quot; +
            &quot;Click \&quot;Ok\&quot; to attempt to reconnect.&quot;
        ),
        onOk: function () {
            document.location.reload();
        }
    }));
    vm.sseErrorDialog().buttonCancel().hide();
    /**
        Navigate to sheet.
        @method tabClicked
        @param {String} name Sheet name
    */
    vm.tabClicked = function (sheet) {
        m.route.set(&quot;/workbook/:workbook/:sheet&quot;, {
            workbook: workbook.data.name().toSpinalCase(),
            sheet: sheet.toSpinalCase()
        });
    };
    /**
        @method tableWidget
        @param {ViewModels.TableWidget} widget
        @return {ViewModels.TableWidget}
    */
    vm.tableWidget = f.prop();
    /**
        @method workbook
        @return {Models.Workbook} dialog
    */
    vm.workbook = function () {
        return workbook;
    };
    /**
        @method zoom
        @param {Integer} percent
        @return {Integer}
    */
    vm.zoom = function (value) {
        let w = vm.tableWidget();
        if (value !== undefined) {
            w.zoom(value);
        }
        return w.zoom();
    };

    // ..........................................................
    // PRIVATE
    //
    feather = catalog.getFeather(vm.sheet().feather);

    // Register callback
    catalog.register(&quot;receivers&quot;, receiverKey, {
        callback: function (model) {
            let tableModel = vm.tableWidget().selection();

            if (!(tableModel &amp;&amp; tableModel.id() === model.id())) {
                vm.tableWidget().models().add(model, true);
            }
        }
    });

    // Create search widget view model
    vm.searchInput(f.createViewModel(&quot;SearchInput&quot;, {
        refresh: vm.refresh
    }));

    // Create table widget view model
    vm.tableWidget(f.createViewModel(&quot;TableWidget&quot;, {
        class: &quot;fb-form-workbook&quot;,
        actions: vm.sheet().actions,
        config: vm.sheet().list,
        isEditModeEnabled: vm.sheet().isEditModeEnabled,
        feather: vm.sheet().feather,
        search: vm.searchInput().value,
        ondblclick: vm.modelOpen,
        subscribe: true,
        footerId: vm.footerId()
    }));

    // Watch when columns change and save profile
    vm.tableWidget().isDragging.state().resolve(&quot;/Changing&quot;).exit(function () {
        if (!vm.tableWidget().isDragging()) {
            vm.saveProfile();
        }
    });

    // Create dialog view models
    vm.filterDialog(f.createViewModel(&quot;FilterDialog&quot;, {
        filter: vm.tableWidget().filter,
        list: vm.tableWidget().models(),
        feather: feather
    }));

    vm.editWorkbookDialog(f.createViewModel(&quot;FormDialog&quot;, {
        icon: &quot;cogs&quot;,
        title: &quot;Edit workbook&quot;,
        model: workbook,
        config: editWorkbookConfig
    }));
    vm.editWorkbookDialog().style().width = &quot;475px&quot;;

    vm.editWorkbookDialog().buttons().push(
        f.prop(f.createViewModel(&quot;Button&quot;, {
            label: &quot;Delete&quot;,
            onclick: function () {
                let dlg = vm.confirmDialog();
                dlg.message(
                    &quot;This will permanently delete this workbook. Are you sure?&quot;
                );
                dlg.icon(&quot;exclamation-triangle&quot;);
                dlg.onOk(function () {
                    let name = workbook.data.name();
                    name = name.toSpinalCase().toCamelCase();

                    function callback() {
                        catalog.unregister(&quot;workbooks&quot;, name);
                        vm.editWorkbookDialog().cancel();
                        m.route.set(&quot;/home&quot;);
                    }

                    workbook.delete(true).then(callback);
                });
                dlg.show();
            },
            class: &quot;fb-button-delete&quot;
        }))
    );
    if (!f.currentUser().isSuper) {
        vm.editWorkbookDialog().buttons()[2]().disable();
        vm.editWorkbookDialog().buttons()[2]().title(
            &quot;Must be a super user to delete this workbook&quot;
        );
    }

    vm.sheetConfigureDialog(sheetConfigureDialog.viewModel({
        parentViewModel: vm,
        sheetId: sheetId
    }));

    vm.sortDialog(f.createViewModel(&quot;SortDialog&quot;, {
        filter: vm.tableWidget().filter,
        list: vm.tableWidget().models(),
        feather: feather
    }));

    // Create button view models
    vm.buttonEdit(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.tableWidget().toggleMode,
        title: &quot;Edit mode&quot;,
        hotkey: &quot;E&quot;,
        icon: &quot;edit&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));
    if (!vm.tableWidget().isEditModeEnabled()) {
        vm.buttonEdit().disable();
    }

    vm.buttonSave(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.tableWidget().save,
        label: &quot;&amp;Save&quot;,
        icon: &quot;cloud-upload-alt&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));
    vm.buttonSave().hide();

    vm.buttonNew(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.modelNew,
        label: &quot;&amp;New&quot;,
        icon: &quot;plus-circle&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));

    vm.buttonDelete(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.tableWidget().modelDelete,
        label: &quot;&amp;Delete&quot;,
        icon: &quot;trash&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));
    vm.buttonDelete().disable();

    if (feather.isReadOnly) {
        vm.buttonNew().disable();
        vm.buttonNew().title(&quot;Table is read only&quot;);
        vm.buttonDelete().title(&quot;Table is read only&quot;);
    }

    vm.buttonUndo(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.tableWidget().undo,
        label: &quot;&amp;Undo&quot;,
        icon: &quot;undo&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));
    vm.buttonUndo().hide();

    vm.buttonRefresh(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.refresh,
        title: &quot;Refresh&quot;,
        hotkey: &quot;R&quot;,
        icon: &quot;sync&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));

    vm.buttonClear(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.searchInput().clear,
        title: &quot;Clear search&quot;,
        hotkey: &quot;C&quot;,
        icon: &quot;eraser&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));
    vm.buttonClear().disable();

    vm.buttonSort(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.showSortDialog,
        icon: &quot;sort&quot;,
        hotkey: &quot;T&quot;,
        title: &quot;Sort results&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));

    vm.buttonFilter(f.createViewModel(&quot;Button&quot;, {
        onclick: vm.showFilterDialog,
        icon: &quot;filter&quot;,
        hotkey: &quot;F&quot;,
        title: &quot;Filter results&quot;,
        class: &quot;fb-toolbar-button&quot;
    }));

    // Bind button states to list statechart events
    listState = vm.tableWidget().models().state();
    listState.resolve(&quot;/Fetched&quot;).enter(function () {
        let model = vm.tableWidget().selection();

        if (model &amp;&amp; model.canUndo()) {
            vm.buttonDelete().hide();
            vm.buttonUndo().show();
            return;
        }

        vm.buttonDelete().show();
        vm.buttonUndo().hide();
    });
    listState.resolve(&quot;/Fetched/Clean&quot;).enter(function () {
        vm.buttonSave().disable();
    });
    listState.state().resolve(&quot;/Fetched/Dirty&quot;).enter(function () {
        vm.buttonSave().enable();
    });

    // Bind button states to search statechart events
    searchState = vm.searchInput().state();
    searchState.resolve(&quot;/Search/On&quot;).enter(function () {
        vm.buttonClear().enable();
    });
    searchState.resolve(&quot;/Search/Off&quot;).enter(function () {
        vm.buttonClear().disable();
    });

    // Bind buttons to table widget state change events
    tableState = vm.tableWidget().state();
    tableState.resolve(&quot;/Mode/View&quot;).enter(function () {
        vm.buttonEdit().deactivate();
        vm.buttonSave().hide();
    });
    tableState.resolve(&quot;/Mode/Edit&quot;).enter(function () {
        vm.buttonEdit().activate();
        vm.buttonSave().show();
    });
    tableState.resolve(&quot;/Selection/Off&quot;).enter(function () {
        vm.buttonDelete().disable();
        vm.buttonDelete().show();
        vm.buttonUndo().hide();
    });
    tableState.resolve(&quot;/Selection/On/Clean&quot;).enter(function () {
        vm.buttonDelete().show();
        vm.buttonUndo().hide();
    });
    tableState.resolve(&quot;/Selection/On/Dirty&quot;).enter(function () {
        vm.buttonDelete().hide();
        vm.buttonUndo().show();
    });

    sseState.resolve(&quot;Error&quot;).enter(function () {
        vm.sseErrorDialog().show();
    });

    catalog.isAuthorized({
        feather: feather.name,
        action: &quot;canCreate&quot;
    }).then(function (canCreate) {
        if (!canCreate) {
            vm.buttonNew().disable();
            vm.buttonNew().title(&quot;Unauthorized&quot;);
        }
    }).catch(function (err) {
        console.error(err.message);
    });

    return vm;
};

/**
    Define workbook component.
    @class WorkbookPage
    @static
    @namespace Components
*/
workbookPage.component = {
    /**
        Must pass view model instance or options to build one.
        @method oninit
        @param {Object} [vnode] Virtual node
        @param {Object} [vnode.attrs] Options
        @param {String} [vnode.attrs.workbook] Workbook name
        @param {Object} [vnode.attrs.key] Worksheet name
        @param {String} [vnode.attrs.isInvalid] Passed if view model
        was determined invalid. View will return nothing.
    */
    oninit: function (vnode) {
        let workbook = vnode.attrs.workbook;
        let sheet = vnode.attrs.key;
        let viewModels = catalog.register(&quot;workbookViewModels&quot;);

        if (viewModels[workbook] &amp;&amp; viewModels[workbook][sheet]) {
            this.viewModel = viewModels[workbook][sheet];
            return;
        }

        this.viewModel = workbookPage.viewModel(vnode.attrs);

        if (vnode.attrs.isInvalid) {
            return; // Nothing to see here folks...
        }

        this.viewModel.menu().selected(workbook);

        // Memoize the model for total state persistence
        if (!viewModels[workbook]) {
            viewModels[workbook] = {};
        }

        viewModels[workbook][sheet] = this.viewModel;
    },

    /**
        @method onupdate
        @param {Object} vnode Virtual node
    */
    onupdate: function (vnode) {
        this.viewModel.menu().selected(vnode.attrs.workbook);
    },

    /**
        @method view
        @param {Object} vnode Virtual node
        @return {Object} view
    */
    view: function (vnode) {
        if (vnode.attrs.isInvalid) {
            return; // Nothing to see here folks...
        }

        let filterMenuClass;
        let tabs;
        let vm = this.viewModel;
        let createTabClass = &quot;pure-button fb-workbook-tab-edit&quot;;
        let deleteTabClass = &quot;pure-button fb-workbook-tab-edit&quot;;
        let activeSheet = vm.sheet();
        let config = vm.config();
        let idx = 0;
        let btn = f.getComponent(&quot;Button&quot;);
        let srtdlg = f.getComponent(&quot;SortDialog&quot;);
        let fltdlg = f.getComponent(&quot;FilterDialog&quot;);
        let frmdlg = f.getComponent(&quot;FormDialog&quot;);
        let srch = f.getComponent(&quot;SearchInput&quot;);
        let tw = f.getComponent(&quot;TableWidget&quot;);
        let dlg = f.getComponent(&quot;Dialog&quot;);
        let nav = f.getComponent(&quot;NavigatorMenu&quot;);
        let menu = f.getComponent(&quot;AccountMenu&quot;);

        if (vm.tableWidget().selections().some((s) =&gt; s.canDelete())) {
            vm.buttonDelete().enable();
        } else {
            vm.buttonDelete().disable();
        }

        // Build tabs
        tabs = vm.sheets().map(function (sheet) {
            let tab;
            let tabOpts;

            // Build tab
            tabOpts = {
                class: (
                    &quot;fb-workbook-tab pure-button&quot; + (
                        activeSheet.name.toName() === sheet.toName()
                        ? &quot; pure-button-primary&quot;
                        : &quot;&quot;
                    )
                ),
                onclick: vm.tabClicked.bind(this, sheet)
            };

            if (vm.config().length &gt; 1) {
                tabOpts.ondragover = vm.ondragover;
                tabOpts.draggable = true;
                tabOpts.ondragstart = vm.ondragstart.bind(this, idx);
                tabOpts.ondrop = vm.ondrop.bind(this, idx, config);
                tabOpts.ondragend = vm.ondragend;
                tabOpts.class += &quot; fb-workbook-tab-draggable&quot;;
            }

            tab = m(&quot;button[type=button]&quot;, tabOpts, sheet.toName());
            idx += 1;

            return tab;
        });

        // Create/delete tab buttons
        if (vm.isDraggingTab()) {
            createTabClass += &quot; fb-workbook-tab-edit-hide&quot;;
            deleteTabClass += &quot; fb-workbook-tab-edit-show&quot;;
        } else {
            createTabClass += &quot; fb-workbook-tab-edit-show&quot;;
            deleteTabClass += &quot; fb-workbook-tab-edit-hide&quot;;
        }

        tabs.push(m(&quot;button[type=button]&quot;, {
            class: createTabClass,
            title: &quot;Add sheet&quot;,
            onclick: vm.newSheet
        }, [m(&quot;i&quot;, {
            class: &quot;fa fa-plus&quot;
        })]));

        // Delete target
        tabs.push(m(&quot;div&quot;, {
            class: deleteTabClass,
            ondragover: vm.ondragover,
            ondrop: vm.deleteSheet
        }, [m(&quot;i&quot;, {
            class: &quot;fa fa-trash&quot;
        })]));

        // Finally assemble the whole view
        filterMenuClass = &quot;pure-menu-link&quot;;
        if (!vm.tableWidget().models().canFilter()) {
            filterMenuClass += &quot; pure-menu-disabled&quot;;
        }

        return m(&quot;div&quot;, {
            class: &quot;pure-form&quot;,
            oncreate: function () {
                let title = vm.sheet().name.toName();
                document.getElementById(&quot;fb-title&quot;).text = title;
            }
        }, [
            m(srtdlg, {
                viewModel: vm.sortDialog()
            }),
            m(fltdlg, {
                viewModel: vm.filterDialog()
            }),
            m(frmdlg, {
                viewModel: vm.editWorkbookDialog()
            }),
            m(sheetConfigureDialog.component, {
                viewModel: vm.sheetConfigureDialog()
            }),
            m(dlg, {
                viewModel: vm.confirmDialog()
            }),
            m(dlg, {
                viewModel: vm.sseErrorDialog()
            }),
            m(&quot;div&quot;, {
                class: &quot;fb-navigator-menu-container&quot;
            }, [
                m(nav, {
                    viewModel: vm.menu()
                }),
                m(&quot;div&quot;, [
                    m(&quot;div&quot;, {
                        id: &quot;toolbar&quot;,
                        class: &quot;fb-toolbar&quot;,
                        onkeydown: vm.onkeydown
                    }, [
                        m(btn, {
                            viewModel: vm.buttonEdit()
                        }),
                        m(btn, {
                            viewModel: vm.buttonSave()
                        }),
                        m(btn, {
                            viewModel: vm.buttonNew()
                        }),
                        m(btn, {
                            viewModel: vm.buttonDelete()
                        }),
                        m(btn, {
                            viewModel: vm.buttonUndo()
                        }),
                        m(&quot;div&quot;, {
                            id: &quot;nav-actions-div&quot;,
                            class: (
                                &quot;pure-menu &quot; +
                                &quot;custom-restricted-width &quot; +
                                &quot;fb-menu&quot;
                            ),
                            onclick: vm.onclickactions,
                            onmouseout: vm.onmouseoutactions
                        }, [
                            m(&quot;span&quot;, {
                                id: &quot;nav-actions-button&quot;,
                                class: (
                                    &quot;pure-button &quot; +
                                    &quot;fa fa-bolt &quot; +
                                    &quot;fb-menu-button&quot;
                                )
                            }),
                            m(&quot;ul&quot;, {
                                id: &quot;nav-actions-list&quot;,
                                class: (
                                    &quot;pure-menu-list fb-menu-list&quot; + (
                                        vm.showActions()
                                        ? &quot; fb-menu-list-show&quot;
                                        : &quot;&quot;
                                    )
                                )
                            }, vm.tableWidget().actions())
                        ]),
                        m(&quot;div&quot;, {
                            class: &quot;fb-toolbar-spacer&quot;
                        }),
                        m(btn, {
                            viewModel: vm.buttonRefresh()
                        }),
                        m(srch, {
                            viewModel: vm.searchInput()
                        }),
                        m(btn, {
                            viewModel: vm.buttonClear()
                        }),
                        m(btn, {
                            viewModel: vm.buttonSort()
                        }),
                        m(btn, {
                            viewModel: vm.buttonFilter()
                        }),
                        m(&quot;div&quot;, {
                            id: &quot;nav-menu-div&quot;,
                            class: (
                                &quot;pure-menu &quot; +
                                &quot;custom-restricted-width &quot; +
                                &quot;fb-menu fb-menu-setup&quot;
                            ),
                            onclick: vm.onclickmenu,
                            onmouseout: vm.onmouseoutmenu
                        }, [
                            m(&quot;span&quot;, {
                                id: &quot;nav-meun-button&quot;,
                                class: (
                                    &quot;pure-button &quot; +
                                    &quot;fa fa-list &quot; +
                                    &quot;fb-menu-button&quot;
                                )
                            }),
                            m(&quot;ul&quot;, {
                                id: &quot;nav-menu-list&quot;,
                                class: (
                                    &quot;pure-menu-list fb-menu-list &quot; +
                                    &quot;fb-menu-list-setup&quot; + (
                                        vm.showMenu()
                                        ? &quot; fb-menu-list-show&quot;
                                        : &quot;&quot;
                                    )
                                )
                            }, [
                                m(&quot;li&quot;, {
                                    id: &quot;nav-menu-configure-worksheet&quot;,
                                    class: &quot;pure-menu-link&quot;,
                                    title: &quot;Configure current worksheet&quot;,
                                    onclick: vm.configureSheet
                                }, [m(&quot;i&quot;, {
                                    id: &quot;nav-menu-configure-worksheet-icon&quot;,
                                    class: &quot;fa fa-table  fb-menu-list-icon&quot;
                                })], &quot;Sheet&quot;),
                                m(&quot;li&quot;, {
                                    id: &quot;nav-menu-configure-workbook&quot;,
                                    class: &quot;pure-menu-link&quot;,
                                    title: &quot;Configure current workbook&quot;,
                                    onclick: vm.editWorkbookDialog().show
                                }, [m(&quot;i&quot;, {
                                    id: &quot;nav-menu-configure-workbook-icon&quot;,
                                    class: &quot;fa fa-cogs  fb-menu-list-icon&quot;
                                })], &quot;Workbook&quot;),
                                m(&quot;li&quot;, {
                                    id: &quot;nav-menu-share&quot;,
                                    class: (
                                        &quot;pure-menu-link &quot; + (
                                            vm.workbook().canUpdate()
                                            ? &quot;&quot;
                                            : &quot; pure-menu-disabled&quot;
                                        )
                                    ),
                                    title: &quot;Share workbook configuration&quot;,
                                    onclick: vm.share
                                }, [m(&quot;i&quot;, {
                                    id: &quot;nav-menu-share-icon&quot;,
                                    class: (
                                        &quot;fa fa-share-alt &quot; +
                                        &quot;fb-menu-list-icon&quot;
                                    )
                                })], &quot;Share&quot;),
                                m(&quot;li&quot;, {
                                    id: &quot;nav-menu-revert&quot;,
                                    class: &quot;pure-menu-link&quot;,
                                    title: (
                                        &quot;Revert workbook configuration &quot; +
                                        &quot;to original state&quot;
                                    ),
                                    onclick: vm.revert
                                }, [m(&quot;i&quot;, {
                                    id: &quot;nav-menu-revert-icon&quot;,
                                    class: &quot;fa fa-reply fb-menu-list-icon&quot;
                                })], &quot;Revert&quot;),
                                m(&quot;li&quot;, {
                                    id: &quot;nav-menu-settings&quot;,
                                    class: (
                                        &quot;pure-menu-link &quot; +
                                        &quot;fb-menu-list-separator&quot; + (
                                            vm.hasSettings()
                                            ? &quot;&quot;
                                            : &quot; pure-menu-disabled&quot;
                                        )
                                    ),
                                    title: &quot;Change module settings&quot;,
                                    onclick: vm.goSettings
                                }, [m(&quot;i&quot;, {
                                    id: &quot;nav-menu-settings-icon&quot;,
                                    class: &quot;fa fa-wrench fb-menu-list-icon&quot;
                                })], &quot;Settings&quot;)
                            ])
                        ]),
                        m(menu)
                    ]),
                    m(tw, {
                        viewModel: vm.tableWidget()
                    }),
                    m(&quot;div&quot;, {
                        id: vm.footerId()
                    }, [
                        tabs,
                        m(&quot;i&quot;, {
                            class: (
                                &quot;fa fa-search-plus &quot; +
                                &quot;fb-zoom-icon fb-zoom-right-icon&quot;
                            )
                        }),
                        m(&quot;input&quot;, {
                            class: &quot;fb-zoom-control&quot;,
                            title: &quot;Zoom &quot; + vm.zoom() + &quot;%&quot;,
                            type: &quot;range&quot;,
                            step: &quot;5&quot;,
                            min: &quot;50&quot;,
                            max: &quot;150&quot;,
                            value: vm.zoom(),
                            oninput: (e) =&gt; vm.zoom(e.target.value)
                        }),
                        m(&quot;i&quot;, {
                            class: (
                                &quot;fa fa-search-minus &quot; +
                                &quot;fb-zoom-icon fb-zoom-left-icon&quot;
                            )
                        })
                    ])
                ])
            ])
        ]);
    }
};

catalog.register(&quot;components&quot;, &quot;workbookPage&quot;, workbookPage.component);

export default Object.freeze(workbookPage);
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
